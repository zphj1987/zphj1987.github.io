

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.jpeg">
  <link rel="icon" href="/img/logo.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="zphj1987">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言如果用cephfs比较多，应该都知道，在cephfs的客户端进行mount以后，看到的容量显示的是集群的总的容量，也就是你的总的磁盘空间是多少这个地方显示的就是多少 这个一直都是这样显示的，我们之前在hammer版本的时候，阿茂和大黄一起在公司内部实现了这个功能，社区会慢慢的集成一些类似的面向面向商业用户的需求 社区已经开发了一个版本，接口都做的差不多了，那么稍微改改，就能实现想要的需求的 本">
<meta property="og:type" content="article">
<meta property="og:title" content="cephfs根据存储池显示df容量">
<meta property="og:url" content="https://zphj1987.com/2018/08/19/cephfs%E6%A0%B9%E6%8D%AE%E5%AD%98%E5%82%A8%E6%B1%A0%E6%98%BE%E7%A4%BAdf%E5%AE%B9%E9%87%8F/index.html">
<meta property="og:site_name" content="磨磨的技术笔记">
<meta property="og:description" content="前言如果用cephfs比较多，应该都知道，在cephfs的客户端进行mount以后，看到的容量显示的是集群的总的容量，也就是你的总的磁盘空间是多少这个地方显示的就是多少 这个一直都是这样显示的，我们之前在hammer版本的时候，阿茂和大黄一起在公司内部实现了这个功能，社区会慢慢的集成一些类似的面向面向商业用户的需求 社区已经开发了一个版本，接口都做的差不多了，那么稍微改改，就能实现想要的需求的 本">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-08-19T03:29:00.000Z">
<meta property="article:modified_time" content="2025-02-13T07:21:00.950Z">
<meta property="article:author" content="zphj1987">
<meta property="article:tag" content="暂未分类">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>cephfs根据存储池显示df容量 - 磨磨的技术笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"zphj1987.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="磨磨的技术笔记" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>磨磨的技术笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.8)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="cephfs根据存储池显示df容量"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2018-08-19 11:29" pubdate>
          2018年8月19日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          21 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">cephfs根据存储池显示df容量</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果用cephfs比较多，应该都知道，在cephfs的客户端进行mount以后，看到的容量显示的是集群的总的容量，也就是你的总的磁盘空间是多少这个地方显示的就是多少</p>
<p>这个一直都是这样显示的，我们之前在hammer版本的时候，阿茂和大黄一起在公司内部实现了这个功能，社区会慢慢的集成一些类似的面向面向商业用户的需求</p>
<p>社区已经开发了一个版本，接口都做的差不多了，那么稍微改改，就能实现想要的需求的</p>
<p>本篇内的改动是基于内核客户端代码的改动，改动很小，应该能够看的懂</p>
<h2 id="改动过程"><a href="#改动过程" class="headerlink" title="改动过程"></a>改动过程</h2><p>首先找到这个补丁</p>
<blockquote>
<p>Improve accuracy of statfs reporting for Ceph filesystems comprising exactly one data pool. In this case, the Ceph monitor can now report the space usage for the single data pool instead of the global data for the entire Ceph cluster. Include support for this message in mon_client and leverage it in ceph&#x2F;super.</p>
</blockquote>
<p>地址：<a target="_blank" rel="noopener" href="https://www.spinics.net/lists/ceph-devel/msg37937.html">https://www.spinics.net/lists/ceph-devel/msg37937.html</a></p>
<p>这个说的是改善了statfs的显示，这个statfs就是在linux下面的mount的输出的显示的，说是改善了在单存储池下的显示效果，也就是在单存储池下能够显示存储池的容量空间，而不是全局的空间</p>
<p>这里就有个疑问了，单存储池？那么多存储池呢？我们测试下看看</p>
<p>这里这个补丁已经打到了centos7.5的默认内核里面去了，也就是内核版本</p>
<blockquote>
<p>Linux lab103 3.10.0-862.el7.x86_64</p>
</blockquote>
<p>对应的rpm包的版本是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># rpm -qa|grep  3.10.0-862</span><br>kernel-devel-3.10.0-862.el7.x86_64<br>kernel-3.10.0-862.el7.x86_64<br></code></pre></td></tr></table></figure>
<p>下载的地址为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://mirrors.163.com/centos/7.5.1804/os/x86_64/Packages/kernel-3.10.0-862.el7.x86_64.rpm<br></code></pre></td></tr></table></figure>
<p>或者直接安装centos7.5也行，这里只要求是这个内核就可以了</p>
<p>我们看下默认情况下是怎样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab102 ~]<span class="hljs-comment"># ceph -s</span><br>  data:<br>    pools:   3 pools, 72 pgs<br>    objects: 22 objects, 36179 bytes<br>    usage:   5209 MB used, 11645 GB / 11650 GB avail<br>    pgs:     72 active+clean<br> <br>[root@lab102 ~]<span class="hljs-comment"># ceph fs ls</span><br>name: ceph, metadata pool: metadata, data pools: [data ]<br>[root@lab102 ~]<span class="hljs-comment"># ceph df</span><br>GLOBAL:<br>    SIZE       AVAIL      bash USED     %bash USED <br>    11650G     11645G        5209M          0.04 <br>POOLS:<br>    NAME         ID     USED      %USED     MAX AVAIL     OBJECTS <br>    data         9          0         0         3671G           0 <br>    metadata     10     36179         0        11014G          22 <br>    newdata      11         0         0         5507G           0 <br>[root@lab102 ~]<span class="hljs-comment"># ceph osd dump|grep pool</span><br>pool 9 <span class="hljs-string">&#x27;data&#x27;</span> replicated size 3 min_size 1 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 last_change 136 flags hashpspool stripe_width 0 application cephfs<br>pool 10 <span class="hljs-string">&#x27;metadata&#x27;</span> replicated size 1 min_size 1 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 last_change 112 flags hashpspool stripe_width 0 application cephfs<br>pool 11 <span class="hljs-string">&#x27;newdata&#x27;</span> replicated size 2 min_size 1 crush_rule 0 object_hash rjenkins pg_num 8 pgp_num 8 last_change 134 flags hashpspool  stripe_width 0 application cephfs<br></code></pre></td></tr></table></figure>
<p>从上面可以看到我的硬盘裸空间为12T左右，data存储池副本3那么可用空间为4T左右，文件系统里面只有一个data存储池，看下挂载的情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ~]<span class="hljs-comment"># uname -a</span><br>Linux lab101 3.10.0-862.el7.x86_64 <span class="hljs-comment">#1 SMP Fri Apr 20 16:44:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span><br>[root@lab101 ~]<span class="hljs-comment"># df -Th|grep mnt</span><br>192.168.19.102:/        ceph      3.6T     0  3.6T   0% /mnt<br></code></pre></td></tr></table></figure>
<p>可以看到显示的容量就是存储池的可用容量为总空间的，现在我们加入一个数据池</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab102 ~]<span class="hljs-comment"># ceph mds add_data_pool newdata</span><br>added data pool 11 to fsmap<br></code></pre></td></tr></table></figure>
<p>再次查看df的显示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ~]<span class="hljs-comment"># df -Th|grep mnt</span><br>192.168.19.102:/        ceph       12T  5.1G   12T   1% /mnt<br></code></pre></td></tr></table></figure>
<p>容量回到了原始的显示的方式，这个跟上面的补丁的预期是一样的，我们看下代码这里怎么控制的</p>
<h2 id="获取当前内核版本的代码"><a href="#获取当前内核版本的代码" class="headerlink" title="获取当前内核版本的代码"></a>获取当前内核版本的代码</h2><p>首先要找到当前的内核的src.rpm包，这样可以拿到当前内核版本的源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget http://vault.centos.org/7.5.1804/os/Source/SPackages/kernel-3.10.0-862.el7.src.rpm<br></code></pre></td></tr></table></figure>
<p>解压源码包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 origin]<span class="hljs-comment"># rpm2cpio kernel-3.10.0-862.el7.src.rpm |cpio -div</span><br>[root@lab103 origin]<span class="hljs-comment"># tar -xvf linux-3.10.0-862.el7.tar.xz</span><br>[root@lab103 origin]<span class="hljs-comment"># cd linux-3.10.0-862.el7/fs/ceph/</span><br></code></pre></td></tr></table></figure>
<p>上面的操作后我们已经进入了我们想要看的源码目录了<br>我们看下super.c这个文件，这个df的显示的控制是在这个文件里面的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># cat super.c |less</span><br></code></pre></td></tr></table></figure>
<p>看下这段代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">static int ceph_statfs(struct dentry *dentry, struct kstatfs *buf)<br>&#123;<br>        struct ceph_fs_client *fsc = ceph_inode_to_client(dentry-&gt;d_inode);<br>        struct ceph_monmap *monmap = fsc-&gt;client-&gt;monc.monmap;<br>        struct ceph_statfs st;<br>        u64 fsid;<br>        int err;<br>        u64 data_pool;<br><br>        <span class="hljs-keyword">if</span> (fsc-&gt;mdsc-&gt;mdsmap-&gt;m_num_data_pg_pools == 1) &#123;<br>                data_pool = fsc-&gt;mdsc-&gt;mdsmap-&gt;m_data_pg_pools[0];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>                data_pool = CEPH_NOPOOL;<br>        &#125;<br><br>        dout(<span class="hljs-string">&quot;statfs\n&quot;</span>);<br>        err = ceph_monc_do_statfs(&amp;fsc-&gt;client-&gt;monc, data_pool, &amp;st);<br>        <span class="hljs-keyword">if</span> (err &lt; 0)<br>                <span class="hljs-built_in">return</span> err;<br></code></pre></td></tr></table></figure>
<p>其中的fsc-&gt;mdsc-&gt;mdsmap-&gt;m_num_data_pg_pools &#x3D;&#x3D; 1和data_pool &#x3D; fsc-&gt;mdsc-&gt;mdsmap-&gt;m_data_pg_pools[0];这个地方的意思是如果fs里面包含的存储池的存储池个数为1那么data_pool就取这个存储池的信息，所以上面的我们的实践过程中的就是单个存储池的时候显示存储池的容量，超过一个的时候就显示的全局的容量，这个是跟代码对应的上的</p>
<p>我们基于上面的已经做好的功能改变一下需求</p>
<blockquote>
<p>需要可以根据自己的需要指定存储池的容量来显示，通过挂载内核客户端的时候传递一个参数进去来进行显示</p>
</blockquote>
<h2 id="代码改动"><a href="#代码改动" class="headerlink" title="代码改动"></a>代码改动</h2><p>[root@lab103 ceph]# vim super.h<br>在super.h内定义一个默认值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#define ZP_POOL_DEFAULT      0  /* pool id */</span><br><span class="hljs-comment">#define CEPH_CAPS_WANTED_DELAY_MAX_DEFAULT     60  /* cap release delay */</span><br>struct ceph_mount_options &#123;<br>        int flags;<br>        int sb_flags;<br><br>        int wsize;            /* max write size */<br>        int rsize;            /* max <span class="hljs-built_in">read</span> size */<br>        int zp_pool;            /* pool <span class="hljs-built_in">id</span> */<br>        int rasize;           /* max readahead */<br></code></pre></td></tr></table></figure>
<p>这里增加了两个一个zp_pool和ZP_POOL_DEFAULT<br>这个文件的改动就只有这么多了</p>
<p>改动super.c的代码<br>在enum里面加上Opt_zp_pool</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">enum &#123;<br>        Opt_wsize,<br>        Opt_rsize,<br>        Opt_rasize,<br>        Opt_caps_wanted_delay_min,<br>        Opt_zp_pool,<br></code></pre></td></tr></table></figure>
<p>在match_table_t fsopt_tokens里面添加Opt_zp_pool相关的判断，我们自己注意传的是pool在fs里面的id即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">static match_table_t fsopt_tokens = &#123;<br>        &#123;Opt_wsize, <span class="hljs-string">&quot;wsize=%d&quot;</span>&#125;,<br>        &#123;Opt_rsize, <span class="hljs-string">&quot;rsize=%d&quot;</span>&#125;,<br>        &#123;Opt_rasize, <span class="hljs-string">&quot;rasize=%d&quot;</span>&#125;,<br>        &#123;Opt_caps_wanted_delay_min, <span class="hljs-string">&quot;caps_wanted_delay_min=%d&quot;</span>&#125;,<br>        &#123;Opt_zp_pool, <span class="hljs-string">&quot;zp_pool=%d&quot;</span>&#125;,<br></code></pre></td></tr></table></figure>
<p>在static int parse_fsopt_token中添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">case</span> Opt_caps_wanted_delay_max:<br>                <span class="hljs-keyword">if</span> (intval &lt; 1)<br>                        <span class="hljs-built_in">return</span> -EINVAL;<br>                fsopt-&gt;caps_wanted_delay_max = intval;<br>                <span class="hljs-built_in">break</span>;<br>        <span class="hljs-keyword">case</span> Opt_zp_pool:<br>                <span class="hljs-keyword">if</span> (intval &lt; 0)<br>                        <span class="hljs-built_in">return</span> -EINVAL;<br>                fsopt-&gt;zp_pool = intval;<br>                <span class="hljs-built_in">break</span>;<br>        <span class="hljs-keyword">case</span> Opt_readdir_max_entries:<br>                <span class="hljs-keyword">if</span> (intval &lt; 1)<br>                        <span class="hljs-built_in">return</span> -EINVAL;<br>                fsopt-&gt;max_readdir = intval;<br>                <span class="hljs-built_in">break</span>;<br></code></pre></td></tr></table></figure>
<p>判断如果小于0就抛错，这个id从0开始上升的，所以也不允许小于0</p>
<p>在static int parse_mount_options中添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">fsopt-&gt;caps_wanted_delay_min = CEPH_CAPS_WANTED_DELAY_MIN_DEFAULT;<br>fsopt-&gt;zp_pool = ZP_POOL_DEFAULT;<br>fsopt-&gt;caps_wanted_delay_max = CEPH_CAPS_WANTED_DELAY_MAX_DEFAULT;<br></code></pre></td></tr></table></figure>
<p>在static int ceph_show_options中添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> (fsopt-&gt;caps_wanted_delay_min != CEPH_CAPS_WANTED_DELAY_MIN_DEFAULT)<br>        seq_printf(m, <span class="hljs-string">&quot;,caps_wanted_delay_min=%d&quot;</span>,<br>                 fsopt-&gt;caps_wanted_delay_min);<br><span class="hljs-keyword">if</span> (fsopt-&gt;zp_pool)<br>        seq_printf(m, <span class="hljs-string">&quot;,zp_pool=%d&quot;</span>,<br>                 fsopt-&gt;zp_pool);<br><span class="hljs-keyword">if</span> (fsopt-&gt;caps_wanted_delay_max != CEPH_CAPS_WANTED_DELAY_MAX_DEFAULT)<br>        seq_printf(m, <span class="hljs-string">&quot;,caps_wanted_delay_max=%d&quot;</span>,<br>                   fsopt-&gt;caps_wanted_delay_max);<br></code></pre></td></tr></table></figure>
<p>这个是用来在执行mount命令的时候显示选项的数值的<br>改动到这里我们检查下我们对super.c做过的的改动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># cat super.c |grep zp_pool</span><br>	Opt_zp_pool,<br>	&#123;Opt_zp_pool, <span class="hljs-string">&quot;zp_pool=%d&quot;</span>&#125;,<br>    <span class="hljs-keyword">case</span> Opt_zp_pool:<br>        fsopt-&gt;zp_pool = intval;<br>	fsopt-&gt;zp_pool = ZP_POOL_DEFAULT;<br>        <span class="hljs-keyword">if</span> (fsopt-&gt;zp_pool)<br>                seq_printf(m, <span class="hljs-string">&quot;,zp_pool=%d&quot;</span>,<br>                         fsopt-&gt;zp_pool);<br></code></pre></td></tr></table></figure>
<p>做了以上的改动后我们就可以把参数给传进来了，现在我们需要把参数传递到需要用的地方<br>也就是static int ceph_statfs内需要调用这个参数</p>
<p>在static int ceph_statfs中添加上struct ceph_mount_options *fsopt &#x3D; fsc-&gt;mount_options;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">static int ceph_statfs(struct dentry *dentry, struct kstatfs *buf)<br>&#123;<br>        struct ceph_fs_client *fsc = ceph_inode_to_client(dentry-&gt;d_inode);<br>        struct ceph_monmap *monmap = fsc-&gt;client-&gt;monc.monmap;<br>        struct ceph_statfs st;<br>        struct ceph_mount_options *fsopt = fsc-&gt;mount_options;<br>        u64 fsid;<br></code></pre></td></tr></table></figure>
<p>然后改掉这个fsc-&gt;mdsc-&gt;mdsmap-&gt;m_num_data_pg_pools &#x3D;&#x3D; 1的判断，我们判断大于0即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> (fsc-&gt;mdsc-&gt;mdsmap-&gt;m_num_data_pg_pools &gt; 0) &#123;<br>        data_pool = fsc-&gt;mdsc-&gt;mdsmap-&gt;m_data_pg_pools[fsopt-&gt;zp_pool];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>        data_pool = CEPH_NOPOOL;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>并且把写死的0改成我们的变量fsopt-&gt;zp_pool</p>
<p>到这里改动就完成了，这里还没有完，我们需要编译成我们的需要的模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># modinfo ceph</span><br>filename:       /lib/modules/3.10.0-862.el7.x86_64/kernel/fs/ceph/ceph.ko.xz<br></code></pre></td></tr></table></figure>
<p>可以看到内核在高版本的时候已经改成了xz压缩的模块了,这里等会需要多处理一步<br>我们只需要这一个模块就编译这一个ceph.ko模块就好<br>编译需要装好kernel-devel包kernel-devel-3.10.0-862.el7.x86_64</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># pwd</span><br>/home/origin/linux-3.10.0-862.el7/fs/ceph<br>[root@lab103 ceph]<span class="hljs-comment"># make CONFIG_CEPH_FS=m -C /lib/modules/3.10.0-862.el7.x86_64/build/ M=`pwd` modules</span><br>make: Entering directory `/usr/src/kernels/3.10.0-862.el7.x86_64<span class="hljs-string">&#x27;</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/super.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/inode.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/dir.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/file.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/locks.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/addr.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/ioctl.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/export.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/caps.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/snap.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/xattr.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/mds_client.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/mdsmap.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/strings.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/ceph_frag.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/debugfs.o</span><br><span class="hljs-string">  CC [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/acl.o</span><br><span class="hljs-string">  LD [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/ceph.o</span><br><span class="hljs-string">  Building modules, stage 2.</span><br><span class="hljs-string">  MODPOST 1 modules</span><br><span class="hljs-string">  CC      /home/origin/linux-3.10.0-862.el7/fs/ceph/ceph.mod.o</span><br><span class="hljs-string">  LD [M]  /home/origin/linux-3.10.0-862.el7/fs/ceph/ceph.ko</span><br><span class="hljs-string">make: Leaving directory `/usr/src/kernels/3.10.0-862.el7.x86_64&#x27;</span><br></code></pre></td></tr></table></figure>
<p>正常应该就是上面的没有报错的输出了<br>压缩ko模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># find * -name &#x27;*.ko&#x27; | xargs -n 1 xz</span><br>[root@lab103 ceph]<span class="hljs-comment"># rmmod ceph</span><br>[root@lab103 ceph]<span class="hljs-comment"># rm -rf  /lib/modules/3.10.0-862.el7.x86_64/kernel/fs/ceph/ceph.ko.xz</span><br>[root@lab103 ceph]<span class="hljs-comment"># cp -ra ceph.ko.xz /lib/modules/3.10.0-862.el7.x86_64/kernel/fs/ceph/</span><br>[root@lab103 ceph]<span class="hljs-comment"># lsmod |grep ceph</span><br>ceph                  345111  0 <br>libceph               301687  1 ceph<br>dns_resolver           13140  1 libceph<br>libcrc32c              12644  2 xfs,libceph<br></code></pre></td></tr></table></figure>
<p>现在已经加载好模块了，我们试验下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># ceph df</span><br>GLOBAL:<br>    SIZE       AVAIL      bash USED     %bash USED <br>    11650G     11645G        5210M          0.04 <br>POOLS:<br>    NAME         ID     USED      %USED     MAX AVAIL     OBJECTS <br>    data         9          0         0         3671G           0 <br>    metadata     10     36391         0        11014G          22 <br>    newdata      11         0         0         5507G           0 <br><br>[root@lab103 ceph]<span class="hljs-comment"># mount -t ceph 192.168.19.102:/ /mnt</span><br>[root@lab103 ceph]<span class="hljs-comment"># df -h|grep mnt</span><br>192.168.19.102:/         3.6T     0  3.6T   0% /mnt<br>[root@lab103 ceph]<span class="hljs-comment"># ceph fs ls</span><br>name: ceph, metadata pool: metadata, data pools: [data newdata ]<br></code></pre></td></tr></table></figure>
<p>我们给了一个默认存储池的值为0的编号的，现在显示的是data的容量，没有问题，我们想显示newdata存储池的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># mount -t ceph 192.168.19.102:/ /mnt -o zp_pool=1</span><br>[root@lab103 ceph]<span class="hljs-comment"># df -h|grep mnt</span><br>192.168.19.102:/         5.4T     0  5.4T   0% /mnt<br></code></pre></td></tr></table></figure>

<p>这里我们显示的要么0，要么1的存储池的那么我如果想显示全局的怎么处理？那就是给个不存在的编号就行了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab103 ceph]<span class="hljs-comment"># mount -t ceph 192.168.19.102:/ /mnt -o zp_pool=1000</span><br>[root@lab103 ceph]<span class="hljs-comment"># mount|grep ceph|grep zp_pool</span><br>192.168.19.102:/ on /mnt <span class="hljs-built_in">type</span> ceph (rw,relatime,acl,wsize=16777216,zp_pool=1000)<br>[root@lab103 ceph]<span class="hljs-comment"># df -h|grep mnt</span><br>192.168.19.102:/          12T  5.1G   12T   1% /mnt<br></code></pre></td></tr></table></figure>
<p>也可以自己去改成读取all字段的时候取全局变量，这个是直接用一个不存在的编号去走到全局的容量的逻辑里面去了,这样比较简单</p>
<p>通过mount命令可以查询到挂载的选项</p>
<p>到这里就根据需求改完了</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇里面涉及的知识点包括了rpm包的源码的获取，解压，以及内核模块的单独编译，改动单个模块进行替换，cephfs客户端的内核参数的自定义传递等等，在本博客的第三篇文章就有一个单独编译一个ext4模块的</p>
<h2 id="变更记录"><a href="#变更记录" class="headerlink" title="变更记录"></a>变更记录</h2><table>
<thead>
<tr>
<th align="center">Why</th>
<th align="center">Who</th>
<th align="center">When</th>
</tr>
</thead>
<tbody><tr>
<td align="center">创建</td>
<td align="center">武汉-运维-磨渣</td>
<td align="center">2018-08-20</td>
</tr>
</tbody></table>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%9A%82%E6%9C%AA%E5%88%86%E7%B1%BB/" class="category-chain-item">暂未分类</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%9A%82%E6%9C%AA%E5%88%86%E7%B1%BB/" class="print-no-link">#暂未分类</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>cephfs根据存储池显示df容量</div>
      <div>https://zphj1987.com/2018/08/19/cephfs根据存储池显示df容量/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>zphj1987</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2018年8月19日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/12/19/%E5%A4%84%E7%90%86ceph%20incompelete%E7%9A%84%E7%BB%8F%E9%AA%8C/" title="处理ceph incompelete的经验">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">处理ceph incompelete的经验</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/07/17/%E5%BF%AB%E9%80%9F%E6%9E%84%E5%BB%BAceph%E5%8F%AF%E8%A7%86%E5%8C%96%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/" title="快速构建ceph可视化监控系统">
                        <span class="hidden-mobile">快速构建ceph可视化监控系统</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      鄂ICP备2025166994号-2
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42011102003786"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>鄂公网安备42011102003786号</span>
        </a>
      </span>
    
  
</div>

  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
