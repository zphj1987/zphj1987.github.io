<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>rgw追加写功能测试验证 | 磨磨的技术笔记</title><meta name="keywords" content="ceph"><meta name="author" content="zphj1987"><meta name="copyright" content="zphj1987"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="rgw追加写功能测试验证"><meta name="application-name" content="rgw追加写功能测试验证"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="rgw追加写功能测试验证"><meta property="og:url" content="https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/index.html"><meta property="og:site_name" content="磨磨的技术笔记"><meta property="og:description" content="背景aws的s3以前是不支持追加写这个功能的  这个存储类型大概是2023年发布的，这个文章是2024年11月21日发布的 找到功能的发布大概时间我们看下boto3的工具是什么时候集成进去的就知道这个功能发布的大概的时间 1WriteOffsetBytes aws里面使用这个参数去控制追加写的偏移量"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://zphj1987.com/images/blog/s3forheader.png"><meta property="article:author" content="zphj1987"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://zphj1987.com/images/blog/s3forheader.png"><meta name="description" content="背景aws的s3以前是不支持追加写这个功能的  这个存储类型大概是2023年发布的，这个文章是2024年11月21日发布的 找到功能的发布大概时间我们看下boto3的工具是什么时候集成进去的就知道这个功能发布的大概的时间 1WriteOffsetBytes aws里面使用这个参数去控制追加写的偏移量"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0a806a1271c36ae0e709307eae2a6eb5";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: {"appId":"GXWN6XTBBN","apiKey":"46fe2a73adf385608a95fb1cf263e589","indexName":"zphj","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: zphj1987","link":"链接: ","source":"来源: 磨磨的技术笔记","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '磨磨的技术笔记',
  title: 'rgw追加写功能测试验证',
  postAI: '',
  pageFillDescription: '背景, 找到功能的发布大概时间, ceph这边的适配, 功能的验证, 确定boto3的位置, 验证追加写功能, aws的追加写方法, restapi追加写的功能, 总结背景的以前是不支持追加写这个功能的这个存储类型大概是年发布的这个文章是年月日发布的找到功能的发布大概时间我们看下的工具是什么时候集成进去的就知道这个功能发布的大概的时间里面使用这个参数去控制追加写的偏移量的我们根据这个关键字去找找到的代码使用下载下来进入到这个目录这个目录里面是的的接口文档也就是不管是用的还是使用进行操作的时候命令行的一些接口都是通过这个目录里面的文件去判断的找到这个文件的所有的历史提交找到了这个地方的提交代码找到这个提交因为这个模型的提交很频繁所以这个提交里面也不会单独说明这个功能查看这次提交确认就是这个提交里面增加的也就是上面的年的月日跟上面的发布时间基本对上了也就是那边发布了接口文档这边适配几个关键字就可以使用相关的功能了这个松耦合做的非常好这边的适配我们看下官方文档返回的关键字是那我们查询这个关键字就知道什么时候合入的这个功能的最开始在年就提出来了这个是阿里云的支持这个功能然后这边做了适配这个地方从时间线上面官方这个发布的时间有点晚在年的月就合入了这个功能了也就是基本上年月后面的主发行版本应该都是支持这个功能的功能的验证官方的说明这个写的是这个目录下面有怎样使用的客户端和的例子以及相关的的扩展一般兼容性接口的做法是基于的原生标准接口再做扩展操作这个里面就是相关的的文件我们需要把官方提供的添加到正在使用的的里面去具体操作下面会写确定的位置这个地方很容易出问题因为可能环境里面装了不同版本的可能重新安装就按照了新的版本也有可能通过不同的命令安装了不同的版本我们需要确定好我们正在使用的的库在哪里安装这里我指定了安装的版本因为对这个的版本有要求然后隔一天重新安装就升级了可以通过上面的命令来按照指定的版本即可确定路径可以看到路径在注意下我们的模型是在这个下面的里面的查看这个文件可以看到这个文件是没有什么内容的我们需要把的扩展放到这个里面这个去自己使用的版本里面找跨版本有可能出现当前版本没支持后面版本支持的情况所以尽量使用当前版本比如上面这个是我要测试的版本的下面是当前最新版本的可以看到路径发生了变化把的放到下面去了这个找下即可替换检查确认下相关的关键字已经放入了上面的就是确认有了验证追加写功能这个是官方提供的例子可以看下大概的内容先删除指定的名称的对象然后在的位置写入字符然后在获取返回的基于写入下一个字符看下的官方的例子大部分是一样的就是对应的是的修改成自己可以用的脚本运行脚本参数是一个名一个对象的名称查看运行的效果可以看到追加写的功能成功了确实有个字符了上面的是使用的的做的的测试用例看下的怎样使用的追加写方法这个是这边的推荐的方法这个里面有个的关键字这个就是对象的偏移量规则是指定名称指定对象的名称指定本地的文件这个指定偏移量的也就是存在的对象的大小这个地方会在命令行这边解析为规则就是大写字符和小写字符之间会插入一个这个是的这边的解析在这边是按和来解析的那么我们可以尝试命令行用这个参数测试下载下来看看再追加再下载再测试可以看到追加写的时候必须正确的指定已经存在的对象的大小位置也就是偏移量从哪里开始追加写返回的位置就是最后的对象的大小可以看到追加写成功了追加写的功能下面是正常的上传的代码不是追加写的功能配置的访问信息的地址计算签名调试信息上传对象到调试信息调试信息使用示例我们再来一个追加写的配置的访问信息的地址计算签名调试信息上传对象到调试信息调试信息使用示例可以看到签名的地方并没有改变改变的就是请求的发生了变化看下运行效果可以看到返回的为也就是下个请求应该从开始查看文件大小再次请求再次查看可以看到文件追加写进去了上面的例子是用的认证做的例子认证比要简单一些总结本篇介绍了这边的的追加写的功能验证可以看到跟类似关键字做一点改变即可本篇从三个工具讲述了里面的追加写的功能的的的方法的工具的方法以及的方法从三个地方讲述了怎样发起追加写的请求整体上还是比较简单就是对着指定的位置发起请求即可就是请求的时候带上一个偏移量',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-12-13 18:12:25',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="磨磨的技术笔记" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/images/logo.jpeg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">其它站点</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/zphj1987" title="CSDN-武汉磨磨"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN-武汉磨磨"/><span class="back-menu-item-text">CSDN-武汉磨磨</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">磨磨的技术笔记</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文库</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章列表</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/sitemap.xml"><span> sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/images/wechatmei.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/wechatmei.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/zhifubaomei.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/zhifubaomei.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/ceph/" style="font-size: 1.05rem;">ceph<sup>15</sup></a><a href="/tags/chatgpt/" style="font-size: 1.05rem;">chatgpt<sup>1</sup></a><a href="/tags/deepseek/" style="font-size: 1.05rem;">deepseek<sup>1</sup></a><a href="/tags/docker/" style="font-size: 1.05rem;">docker<sup>2</sup></a><a href="/tags/exsi/" style="font-size: 1.05rem;">exsi<sup>1</sup></a><a href="/tags/iscsi%E7%9B%B8%E5%85%B3/" style="font-size: 1.05rem;">iscsi相关<sup>1</sup></a><a href="/tags/lvm/" style="font-size: 1.05rem;">lvm<sup>1</sup></a><a href="/tags/macos/" style="font-size: 1.05rem;">macos<sup>1</sup></a><a href="/tags/openai/" style="font-size: 1.05rem;">openai<sup>1</sup></a><a href="/tags/samba/" style="font-size: 1.05rem;">samba<sup>1</sup></a><a href="/tags/windows/" style="font-size: 1.05rem;">windows<sup>2</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 1.05rem;">内核<sup>2</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2%E7%9B%B8%E5%85%B3/" style="font-size: 1.05rem;">博客相关<sup>1</sup></a><a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 1.05rem;">存储<sup>1</sup></a><a href="/tags/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/" style="font-size: 1.05rem;">存储相关<sup>1</sup></a><a href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" style="font-size: 1.05rem;">异常处理<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">操作系统<sup>2</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">数据管理<sup>1</sup></a><a href="/tags/%E6%9A%82%E6%9C%AA%E5%88%86%E7%B1%BB/" style="font-size: 1.05rem;">暂未分类<sup>302</sup></a><a href="/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" style="font-size: 1.05rem;">杂七杂八<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">测试<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3/" style="font-size: 1.05rem;">测试相关<sup>1</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 1.05rem;">监控<sup>1</sup></a><a href="/tags/%E7%A3%81%E7%9B%98/" style="font-size: 1.05rem;">磁盘<sup>1</sup></a><a href="/tags/%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3/" style="font-size: 1.05rem;">磁盘相关<sup>1</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/" style="font-size: 1.05rem;">系统服务<sup>1</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/" style="font-size: 1.05rem;">系统配置<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 1.05rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 1.05rem;">虚拟化<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size: 1.05rem;">计算机<sup>1</sup></a><a href="/tags/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" style="font-size: 1.05rem;">问题处理<sup>1</sup></a><a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/" style="font-size: 1.05rem;">高可用<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">10</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/" itemprop="url">存储系统</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/ceph/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ceph</span></a></span></div></div><h1 class="post-title" itemprop="name headline">rgw追加写功能测试验证</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-12-13T09:24:30.000Z" title="发表于 2024-12-13 17:24:30">2024-12-13</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-12-13T10:12:25.628Z" title="更新于 2024-12-13 18:12:25">2024-12-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="rgw追加写功能测试验证"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为武汉"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>武汉</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/images/blog/s3forheader.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/"><header><a class="post-meta-categories" href="/categories/%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/" itemprop="url">存储系统</a><a href="/tags/ceph/" tabindex="-1" itemprop="url">ceph</a><h1 id="CrawlerTitle" itemprop="name headline">rgw追加写功能测试验证</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">zphj1987</span><time itemprop="dateCreated datePublished" datetime="2024-12-13T09:24:30.000Z" title="发表于 2024-12-13 17:24:30">2024-12-13</time><time itemprop="dateCreated datePublished" datetime="2024-12-13T10:12:25.628Z" title="更新于 2024-12-13 18:12:25">2024-12-13</time></header><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>aws的s3以前是不支持追加写这个功能的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/Pasted%20image%2020241213100200.png"></p>
<p>这个存储类型大概是2023年发布的，这个文章是2024年11月21日发布的</p>
<h3 id="找到功能的发布大概时间"><a href="#找到功能的发布大概时间" class="headerlink" title="找到功能的发布大概时间"></a>找到功能的发布大概时间</h3><p>我们看下boto3的工具是什么时候集成进去的就知道这个功能发布的大概的时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WriteOffsetBytes</span><br></pre></td></tr></table></figure>
<p>aws里面使用这个参数去控制追加写的偏移量的，我们根据这个关键字去找</p>
<p>找到botcore的代码，使用git下载下来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>  botocore/botocore/data/s3/2006-03-01</span><br></pre></td></tr></table></figure>
<p>进入到这个目录，这个目录里面是aws的s3的接口文档，也就是不管是用python的sdk还是使用aws进行操作的时候，命令行的一些接口都是通过这个目录里面的json文件去判断的</p>
<p>找到这个文件的所有的历史提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> -p service-2.json</span><br></pre></td></tr></table></figure>

<p>找到了这个地方的提交代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@@ -9579,6 +9667,12 @@</span><br><span class="line">           <span class="string">&quot;location&quot;</span>:<span class="string">&quot;uri&quot;</span>,</span><br><span class="line">           <span class="string">&quot;locationName&quot;</span>:<span class="string">&quot;Key&quot;</span></span><br><span class="line">         &#125;,</span><br><span class="line">+        <span class="string">&quot;WriteOffsetBytes&quot;</span>:&#123;</span><br><span class="line">+          <span class="string">&quot;shape&quot;</span>:<span class="string">&quot;WriteOffsetBytes&quot;</span>,</span><br><span class="line">+          <span class="string">&quot;documentation&quot;</span>:<span class="string">&quot;&lt;p&gt; Specifies the offset for appending data to existing objects in bytes. The offset must be equal to the size of the existing object being appended to. If no object exists, setting this header to 0 will create a new object. &lt;/p&gt; &lt;note&gt; &lt;p&gt;This functionality is only supported for objects in the Amazon S3 Express One Zone storage class in directory buckets.&lt;/p&gt; &lt;/note&gt;&quot;</span>,</span><br><span class="line">+          <span class="string">&quot;location&quot;</span>:<span class="string">&quot;header&quot;</span>,</span><br><span class="line">+          <span class="string">&quot;locationName&quot;</span>:<span class="string">&quot;x-amz-write-offset-bytes&quot;</span></span><br><span class="line">+        &#125;,</span><br></pre></td></tr></table></figure>

<p>找到5c8efd314eee44949f6a9e1fb8af522c654ded15这个提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">commit 5c8efd314eee44949f6a9e1fb8af522c654ded15</span><br><span class="line">Author: aws-sdk-python-automation &lt;github-aws-sdk-python-automation@amazon.com&gt;</span><br><span class="line">Date:   Fri Nov 22 00:52:00 2024 +0000</span><br><span class="line"></span><br><span class="line">    Update to latest models</span><br></pre></td></tr></table></figure>
<p>因为这个模型的提交很频繁，所以这个提交里面也不会单独说明这个功能</p>
<p>查看这次提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git  show 5c8efd314eee44949f6a9e1fb8af522c654ded15  service-2.json</span><br></pre></td></tr></table></figure>

<p>确认就是这个提交里面增加的</p>
<p>也就是上面的2024年的11月21日，跟上面的发布时间基本对上了，也就是那边发布了接口文档，这边适配几个关键字就可以使用相关的功能了，这个松耦合做的非常好</p>
<h2 id="ceph这边的适配"><a href="#ceph这边的适配" class="headerlink" title="ceph这边的适配"></a>ceph这边的适配</h2><p>我们看下官方文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.ceph.com/en/reef/radosgw/s3/objectops/</span><br></pre></td></tr></table></figure>

<p>返回的关键字是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x-rgw-next-append-position</span><br></pre></td></tr></table></figure>

<p>那我们查询这个关键字就知道什么时候合入的这个功能的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/Pasted%20image%2020241213103133.png"></p>
<p>最开始在2018年就提出来了，这个是阿里云的oss支持这个功能，然后ceph这边做了适配，这个地方从时间线上面aws官方这个发布的时间有点晚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/Pasted%20image%2020241213103407.png"></p>
<p>在2019年的2月就合入了这个功能了，也就是基本上2019年2月后面的主发行版本应该都是支持这个功能的</p>
<h2 id="功能的验证"><a href="#功能的验证" class="headerlink" title="功能的验证"></a>功能的验证</h2><p>官方的说明</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/main/examples/rgw/boto3/README.md">https://github.com/ceph/ceph/blob/main/examples/rgw/boto3/README.md</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">This directory contains examples on how to use AWS CLI/boto3 to exercise the RadosGW extensions to the S3 API. This is an extension to the [AWS SDK](https://github.com/boto/botocore/blob/develop/botocore/data/s3/2006-03-01/service-2.json).</span><br><span class="line"></span><br><span class="line">For the standard client to support these extensions, the `service-2.sdk-extras.json` file should be added. You can place it under the default folder `~/.aws/models/s3/2006-03-01/` or create a custom one `/path/to/custom/folder/models/s3/2006-03-01/` and add it to `AWS_DATA_PATH` environment variable. For more information see [here](https://github.com/boto/botocore/blob/develop/botocore/loaders.py<span class="comment">#L33).</span></span><br></pre></td></tr></table></figure>

<p>这个写的是，这个目录下面有怎样使用aws的客户端和boto3的例子，以及相关的api的扩展，一般兼容性s3接口的做法是基于s3的原生标准接口再做扩展操作，这个里面就是相关的api的文件，我们需要把ceph官方提供的service-2.sdk-extras.json，添加到正在使用的boto3的sdk里面去，具体操作下面会写</p>
<h2 id="确定boto3的位置"><a href="#确定boto3的位置" class="headerlink" title="确定boto3的位置"></a>确定boto3的位置</h2><p>这个地方很容易出问题，因为可能环境里面装了不同版本的boto3，可能重新安装就按照了新的版本，也有可能通过不同的命令安装了不同的版本，我们需要确定好我们正在使用的boto3的库在哪里</p>
<p>安装boto3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 site-packages]<span class="comment"># pip3 install boto3==1.35.79  botocore==1.35.79  -i https://mirrors.aliyun.com/pypi/simple</span></span><br></pre></td></tr></table></figure>

<p>这里我指定了安装的版本，因为aws对这个botocore的版本有要求，然后隔一天boto重新安装就升级了，可以通过上面的命令来按照指定的版本即可</p>
<p>确定路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 site-packages]<span class="comment"># python3</span></span><br><span class="line">Python 3.9.6 (default, Dec 12 2024, 16:15:26)</span><br><span class="line">[GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import botocore</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(botocore)</span><br><span class="line">&lt;module <span class="string">&#x27;botocore&#x27;</span> from <span class="string">&#x27;/usr/local/lib/python3.9/site-packages/botocore/__init__.py&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到路径在</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/lib/python3.9/site-packages/botocore</span><br></pre></td></tr></table></figure>
<p>注意下我们的模型是在这个下面的botocore里面的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 2006-03-01]<span class="comment"># ll /usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/</span></span><br><span class="line">total 248</span><br><span class="line">-rw-r--r-- 1 root root  18305 Dec 13 10:48 endpoint-rule-set-1.json.gz</span><br><span class="line">-rw-r--r-- 1 root root  57596 Dec 13 10:48 examples-1.json</span><br><span class="line">-rw-r--r-- 1 root root   1837 Dec 13 10:48 paginators-1.json</span><br><span class="line">-rw-r--r-- 1 root root    856 Dec 13 10:48 paginators-1.sdk-extras.json</span><br><span class="line">-rw-r--r-- 1 root root 154059 Dec 13 10:48 service-2.json.gz</span><br><span class="line">-rw-r--r-- 1 root root     98 Dec 13 10:48 service-2.sdk-extras.json</span><br><span class="line">-rw-r--r-- 1 root root   1436 Dec 13 10:48 waiters-2.json</span><br></pre></td></tr></table></figure>
<p>查看这个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 2006-03-01]<span class="comment"># cat /usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/service-2.sdk-extras.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: 1.0,</span><br><span class="line">  <span class="string">&quot;merge&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;shapes&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;Expires&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;timestamp&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这个文件是没有什么内容的，我们需要把ceph的扩展放到这个里面 </p>
<p>这个去自己使用的ceph版本里面找，跨版本有可能出现当前版本没支持，后面版本支持的情况，所以尽量使用当前版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/ceph/ceph/blob/v15.2.17/examples/boto3/service-2.sdk-extras.json</span><br></pre></td></tr></table></figure>

<p>比如上面这个是我要测试的版本的，下面是当前最新版本的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/ceph/ceph/blob/main/examples/rgw/boto3/service-2.sdk-extras.json</span><br></pre></td></tr></table></figure>

<p>可以看到路径发生了变化，把boto3的放到rgw下面去了，这个找下即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ~]<span class="comment">#wget  https://raw.githubusercontent.com/ceph/ceph/refs/heads/main/examples/rgw/boto3/service-2.sdk-extras.json</span></span><br><span class="line">[root@lab101 ~]<span class="comment"># cp service-2.sdk-extras.json /usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/service-2.sdk-extras.json</span></span><br><span class="line"><span class="built_in">cp</span>: overwrite ‘/usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/service-2.sdk-extras.json’? y</span><br></pre></td></tr></table></figure>

<p>替换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 2006-03-01]<span class="comment"># cat service-2.sdk-extras.json |grep Append</span></span><br><span class="line">                <span class="string">&quot;AppendPosition&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;shape&quot;</span>:<span class="string">&quot;AppendPosition&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Append&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;shape&quot;</span>:<span class="string">&quot;Append&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;documentation&quot;</span>:<span class="string">&quot;&lt;p&gt;Append Object&lt;/p&gt;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Append&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;boolean&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;AppendPosition&quot;</span>:&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;integer&quot;</span>&#125;,</span><br><span class="line">                <span class="string">&quot;AppendPosition&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;shape&quot;</span>:<span class="string">&quot;AppendPosition&quot;</span>,</span><br></pre></td></tr></table></figure>
<p>检查确认下相关的关键字已经放入了，上面的就是确认有了</p>
<h3 id="验证追加写功能"><a href="#验证追加写功能" class="headerlink" title="验证追加写功能"></a>验证追加写功能</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/v15.2.17/examples/boto3/append_object.py">https://github.com/ceph/ceph/blob/v15.2.17/examples/boto3/append_object.py</a></p>
</blockquote>
<p>这个是ceph官方提供的例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/python</span></span><br><span class="line">from __future__ import print_function</span><br><span class="line"></span><br><span class="line">import boto3</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">def js_print(arg):</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(arg, indent=2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) != 3:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Usage: &#x27;</span> + sys.argv[0] + <span class="string">&#x27; &lt;bucket&gt; &lt;key&gt;&#x27;</span>)</span><br><span class="line">    sys.exit(1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bucket name as first argument</span></span><br><span class="line">bucketname = sys.argv[1]</span><br><span class="line">keyname = sys.argv[2]</span><br><span class="line"><span class="comment"># endpoint and keys from vstart</span></span><br><span class="line">endpoint = <span class="string">&#x27;http://127.0.0.1:8000&#x27;</span></span><br><span class="line">access_key=<span class="string">&#x27;0555b35654ad1656d804&#x27;</span></span><br><span class="line">secret_key=<span class="string">&#x27;h7GhxuBLTrlhVUyxSPUKUV8r/2EI4ngqJxD7iBdBYLhwluN30JaT3Q==&#x27;</span></span><br><span class="line"></span><br><span class="line">client = boto3.client(<span class="string">&#x27;s3&#x27;</span>,</span><br><span class="line">        endpoint_url=endpoint,</span><br><span class="line">        aws_access_key_id=access_key,</span><br><span class="line">        aws_secret_access_key=secret_key)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;deleting object first&#x27;</span>)</span><br><span class="line">js_print(client.delete_object(Bucket=bucketname, Key=keyname))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;appending at position 0&#x27;</span>)</span><br><span class="line">resp = client.put_object(Bucket=bucketname, Key=keyname,</span><br><span class="line">                         Append=True,</span><br><span class="line">                         AppendPosition=0,</span><br><span class="line">                         Body=<span class="string">&#x27;8letters&#x27;</span>)</span><br><span class="line"></span><br><span class="line">js_print(resp)</span><br><span class="line">append_pos = resp[<span class="string">&#x27;AppendPosition&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;appending at position %d&#x27;</span> % append_pos)</span><br><span class="line">js_print(client.put_object(Bucket=bucketname, Key=keyname,</span><br><span class="line">                           Append=True,</span><br><span class="line">                           AppendPosition=append_pos,</span><br><span class="line">                           Body=<span class="string">&#x27;8letters&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>可以看下大概的内容</p>
<ul>
<li>先删除指定的名称的对象</li>
<li>然后在0的位置写入8letters字符</li>
<li>然后在获取返回的AppendPosition</li>
<li>基于AppendPosition写入下一个8letters字符</li>
</ul>
<p>看下aws的官方的例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s3.put_object(Bucket=<span class="string">&#x27;amzn-s3-demo-bucket--use2-az2--x-s3&#x27;</span>, Key=<span class="string">&#x27;2024-11-05-sdk-test&#x27;</span>, Body=b<span class="string">&#x27;123456789&#x27;</span>, WriteOffsetBytes=9)</span><br></pre></td></tr></table></figure>
<p>大部分是一样的，就是WriteOffsetBytes对应的是ceph的AppendPosition</p>
<p>修改成自己可以用的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># cat test.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line">from __future__ import print_function</span><br><span class="line"></span><br><span class="line">import boto3</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">def js_print(arg):</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(arg, indent=2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) != 3:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Usage: &#x27;</span> + sys.argv[0] + <span class="string">&#x27; &lt;bucket&gt; &lt;key&gt;&#x27;</span>)</span><br><span class="line">    sys.exit(1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bucket name as first argument</span></span><br><span class="line">bucketname = sys.argv[1]</span><br><span class="line">keyname = sys.argv[2]</span><br><span class="line"><span class="comment"># endpoint and keys from vstart</span></span><br><span class="line">endpoint = <span class="string">&#x27;http://192.168.0.101:7481&#x27;</span></span><br><span class="line">access_key=<span class="string">&#x27;test1&#x27;</span></span><br><span class="line">secret_key=<span class="string">&#x27;test1&#x27;</span></span><br><span class="line"></span><br><span class="line">client = boto3.client(<span class="string">&#x27;s3&#x27;</span>,</span><br><span class="line">        endpoint_url=endpoint,</span><br><span class="line">        aws_access_key_id=access_key,</span><br><span class="line">        aws_secret_access_key=secret_key)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;deleting object first&#x27;</span>)</span><br><span class="line">js_print(client.delete_object(Bucket=bucketname, Key=keyname))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;appending at position 0&#x27;</span>)</span><br><span class="line">resp = client.put_object(Bucket=bucketname, Key=keyname,</span><br><span class="line">                         Append=True,</span><br><span class="line">                         AppendPosition=0,</span><br><span class="line">                         Body=<span class="string">&#x27;8letters&#x27;</span>)</span><br><span class="line"></span><br><span class="line">js_print(resp)</span><br><span class="line">append_pos = resp[<span class="string">&#x27;AppendPosition&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;appending at position %d&#x27;</span> % append_pos)</span><br><span class="line">js_print(client.put_object(Bucket=bucketname, Key=keyname,</span><br><span class="line">                           Append=True,</span><br><span class="line">                           AppendPosition=append_pos,</span><br><span class="line">                           Body=<span class="string">&#x27;8letters&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>运行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># python3 test.py testbucket myappend.txt</span></span><br><span class="line">deleting object first</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ResponseMetadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;RequestId&quot;</span>: <span class="string">&quot;tx000001eb3924743c3404f-00675ba47a-37bd-default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HostId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HTTPStatusCode&quot;</span>: 204,</span><br><span class="line">    <span class="string">&quot;HTTPHeaders&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;x-amz-request-id&quot;</span>: <span class="string">&quot;tx000001eb3924743c3404f-00675ba47a-37bd-default&quot;</span>,</span><br><span class="line">      <span class="string">&quot;date&quot;</span>: <span class="string">&quot;Fri, 13 Dec 2024 03:05:30 GMT&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RetryAttempts&quot;</span>: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">appending at position 0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ResponseMetadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;RequestId&quot;</span>: <span class="string">&quot;tx00000952a1aea29f3ea2f-00675ba47a-37bd-default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HostId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HTTPStatusCode&quot;</span>: 200,</span><br><span class="line">    <span class="string">&quot;HTTPHeaders&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;content-length&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;etag&quot;</span>: <span class="string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;accept-ranges&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">      <span class="string">&quot;x-rgw-next-append-position&quot;</span>: <span class="string">&quot;8&quot;</span>,</span><br><span class="line">      <span class="string">&quot;x-amz-request-id&quot;</span>: <span class="string">&quot;tx00000952a1aea29f3ea2f-00675ba47a-37bd-default&quot;</span>,</span><br><span class="line">      <span class="string">&quot;date&quot;</span>: <span class="string">&quot;Fri, 13 Dec 2024 03:05:30 GMT&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RetryAttempts&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;ETag&quot;</span>: <span class="string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;AppendPosition&quot;</span>: 8</span><br><span class="line">&#125;</span><br><span class="line">appending at position 8</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ResponseMetadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;RequestId&quot;</span>: <span class="string">&quot;tx00000bb44851eb1f0253d-00675ba47a-37bd-default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HostId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HTTPStatusCode&quot;</span>: 200,</span><br><span class="line">    <span class="string">&quot;HTTPHeaders&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;content-length&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;etag&quot;</span>: <span class="string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;accept-ranges&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">      <span class="string">&quot;x-rgw-next-append-position&quot;</span>: <span class="string">&quot;16&quot;</span>,</span><br><span class="line">      <span class="string">&quot;x-amz-request-id&quot;</span>: <span class="string">&quot;tx00000bb44851eb1f0253d-00675ba47a-37bd-default&quot;</span>,</span><br><span class="line">      <span class="string">&quot;date&quot;</span>: <span class="string">&quot;Fri, 13 Dec 2024 03:05:30 GMT&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RetryAttempts&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;ETag&quot;</span>: <span class="string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;AppendPosition&quot;</span>: 16</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数是一个bucket名，一个对象的名称</p>
<p>查看运行的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># aws --endpoint=http://192.168.0.101:7481 s3 cp  s3://testbucket/myappend.txt  myappend.txt</span></span><br><span class="line">download: s3://testbucket/myappend.txt to ./myappend.txt</span><br><span class="line">[root@lab101 ceph]<span class="comment"># cat myappend.txt</span></span><br><span class="line">8letters8letters[root@lab101 ceph]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>可以看到追加写的功能成功了,确实有16个字符了</p>
<p>上面的是使用的boto3的sdk做的python的测试用例，看下aws的怎样使用</p>
<h2 id="aws的追加写方法"><a href="#aws的追加写方法" class="headerlink" title="aws的追加写方法"></a>aws的追加写方法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.aws.amazon.com/AmazonS3/latest/userguide/directory-buckets-objects-append.html</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object --bucket amzn-s3-demo-bucket--azid--x-s3 --key sampleinput/file001.bin --body bucket-seed/file001.bin --write-offset-bytes size-of-sampleinput/file001.bin</span><br></pre></td></tr></table></figure>

<p>这个是aws这边的推荐的方法，这个里面有个write-offset-bytes的关键字，这个就是对象的偏移量<br>规则是：<br>指定bucket名称 key指定对象的名称 body指定本地的文件 write-offset-bytes 这个指定偏移量的，也就是存在的对象的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 2006-03-01]<span class="comment"># cat service-2.json |grep WriteOffsetBytes</span></span><br><span class="line">        <span class="string">&quot;WriteOffsetBytes&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;shape&quot;</span>:<span class="string">&quot;WriteOffsetBytes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;WriteOffsetBytes&quot;</span>:&#123;</span><br></pre></td></tr></table></figure>
<p>这个地方WriteOffsetBytes会在命令行这边解析为 –write-offset-bytes<br>规则就是大写字符和小写字符之间会插入一个-</p>
<p>这个是aws的这边的解析，在ceph这边是按AppendPosition和Append来解析的，那么我们可以尝试命令行用这个参数测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ~]<span class="comment"># cat zpappend.txt</span></span><br><span class="line">aaaaaaa</span><br><span class="line">[root@lab101 ~]<span class="comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 0</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;ETag&quot;</span>: <span class="string">&quot;\&quot;15fe514867dd5b4a1abf91ea35ff9e22\&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AppendPosition&quot;</span>: 8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下载下来看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># aws --endpoint=http://192.168.0.101:7481 s3 cp s3://testbucket/newappend.txt newappend.txt</span></span><br><span class="line">download: s3://testbucket/newappend.txt to ./newappend.txt</span><br><span class="line">[root@lab101 ceph]<span class="comment"># cat newappend.txt</span></span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

<p>再追加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ~]<span class="comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 8</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;ETag&quot;</span>: <span class="string">&quot;\&quot;15fe514867dd5b4a1abf91ea35ff9e22\&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AppendPosition&quot;</span>: 16</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># aws --endpoint=http://192.168.0.101:7481 s3 cp s3://testbucket/newappend.txt newappend.txt</span></span><br><span class="line">download: s3://testbucket/newappend.txt to ./newappend.txt</span><br><span class="line">[root@lab101 ceph]<span class="comment"># cat newappend.txt</span></span><br><span class="line">aaaaaaa</span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

<p>再测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ~]<span class="comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 8</span></span><br><span class="line"></span><br><span class="line">An error occurred (PositionNotEqualToLength) when calling the PutObject operation: Unknown</span><br><span class="line">[root@lab101 ~]<span class="comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 16</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;ETag&quot;</span>: <span class="string">&quot;\&quot;15fe514867dd5b4a1abf91ea35ff9e22\&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;AppendPosition&quot;</span>: 24</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，追加写的时候必须正确的指定已经存在的对象的大小位置，也就是偏移量，从哪里开始追加写</p>
<p>返回的位置就是最后的对象的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># aws --endpoint=http://192.168.0.101:7481 s3 ls s3://testbucket/newappend.txt</span></span><br><span class="line">2024-12-13 11:22:10         24 newappend.txt</span><br></pre></td></tr></table></figure>

<p>可以看到追加写成功了</p>
<h2 id="restapi追加写的功能"><a href="#restapi追加写的功能" class="headerlink" title="restapi追加写的功能"></a>restapi追加写的功能</h2><p>下面是正常的上传的代码，不是追加写的功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># cat test1.py</span></span><br><span class="line"><span class="comment">#! /usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">import requests</span><br><span class="line">import hashlib</span><br><span class="line">import hmac</span><br><span class="line">import datetime</span><br><span class="line">import <span class="built_in">base64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Ceph RGW 的访问信息</span></span><br><span class="line">ACCESS_KEY = <span class="string">&quot;test1&quot;</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;test1&quot;</span></span><br><span class="line">RGW_ENDPOINT = <span class="string">&quot;http://192.168.0.101:7481&quot;</span>  <span class="comment"># Ceph RADOS Gateway 的地址</span></span><br><span class="line">BUCKET_NAME = <span class="string">&quot;testbucket&quot;</span></span><br><span class="line">OBJECT_KEY = <span class="string">&quot;testrest.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 AWS S3 签名</span></span><br><span class="line">def generate_signature(method, bucket, object_key, content_type, <span class="built_in">date</span>, secret_key):</span><br><span class="line">    string_to_sign = f<span class="string">&quot;&#123;method&#125;\n\n&#123;content_type&#125;\n&#123;date&#125;\n/&#123;bucket&#125;/&#123;object_key&#125;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;String to sign:&quot;</span>, string_to_sign)  <span class="comment"># 调试信息</span></span><br><span class="line">    signature = hmac.new(secret_key.encode(<span class="string">&#x27;utf-8&#x27;</span>), string_to_sign.encode(<span class="string">&#x27;utf-8&#x27;</span>), hashlib.sha1).digest()</span><br><span class="line">    <span class="built_in">return</span> base64.b64encode(signature).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传对象到 Ceph</span></span><br><span class="line">def upload_object(file_path):</span><br><span class="line">    with open(file_path, <span class="string">&quot;rb&quot;</span>) as f:</span><br><span class="line">        file_data = f.read()</span><br><span class="line"></span><br><span class="line">    content_type = <span class="string">&quot;application/octet-stream&quot;</span></span><br><span class="line">    <span class="built_in">date</span> = datetime.datetime.utcnow().strftime(<span class="string">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span>)</span><br><span class="line"></span><br><span class="line">    signature = generate_signature(</span><br><span class="line">        method=<span class="string">&quot;PUT&quot;</span>,</span><br><span class="line">        bucket=BUCKET_NAME,</span><br><span class="line">        object_key=OBJECT_KEY,</span><br><span class="line">        content_type=content_type,</span><br><span class="line">        <span class="built_in">date</span>=<span class="built_in">date</span>,</span><br><span class="line">        secret_key=SECRET_KEY</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: content_type,</span><br><span class="line">        <span class="string">&quot;Date&quot;</span>: <span class="built_in">date</span>,</span><br><span class="line">        <span class="string">&quot;Authorization&quot;</span>: f<span class="string">&quot;AWS &#123;ACCESS_KEY&#125;:&#123;signature&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    url = f<span class="string">&quot;&#123;RGW_ENDPOINT&#125;/&#123;BUCKET_NAME&#125;/&#123;OBJECT_KEY&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Request URL:&quot;</span>, url)  <span class="comment"># 调试信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Headers:&quot;</span>, headers)  <span class="comment"># 调试信息</span></span><br><span class="line"></span><br><span class="line">    response = requests.put(url, headers=headers, data=file_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response.status_code == 200:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Upload successful!&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(f<span class="string">&quot;Upload failed! Status code: &#123;response.status_code&#125;, Response: &#123;response.text&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    upload_object(<span class="string">&quot;zp.txt&quot;</span>)</span><br></pre></td></tr></table></figure>


<p>我们再来一个追加写的restapi</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># cat test4.py</span></span><br><span class="line"><span class="comment">#! /usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">import requests</span><br><span class="line">import hashlib</span><br><span class="line">import hmac</span><br><span class="line">import datetime</span><br><span class="line">import <span class="built_in">base64</span></span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Ceph RGW 的访问信息</span></span><br><span class="line">ACCESS_KEY = <span class="string">&quot;test1&quot;</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;test1&quot;</span></span><br><span class="line">RGW_ENDPOINT = <span class="string">&quot;http://192.168.0.101:7481&quot;</span>  <span class="comment"># Ceph RADOS Gateway 的地址</span></span><br><span class="line">BUCKET_NAME = <span class="string">&quot;testbucket&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 AWS S3 签名</span></span><br><span class="line">def generate_signature(method, bucket, object_key, content_type, <span class="built_in">date</span>, secret_key):</span><br><span class="line">    string_to_sign = f<span class="string">&quot;&#123;method&#125;\n\n&#123;content_type&#125;\n&#123;date&#125;\n/&#123;bucket&#125;/&#123;object_key&#125;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;String to sign:&quot;</span>, string_to_sign)  <span class="comment"># 调试信息</span></span><br><span class="line">    signature = hmac.new(secret_key.encode(<span class="string">&#x27;utf-8&#x27;</span>), string_to_sign.encode(<span class="string">&#x27;utf-8&#x27;</span>), hashlib.sha1).digest()</span><br><span class="line">    <span class="built_in">return</span> base64.b64encode(signature).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传对象到 Ceph</span></span><br><span class="line">def upload_object(object_key, file_path, position):</span><br><span class="line">    with open(file_path, <span class="string">&quot;rb&quot;</span>) as f:</span><br><span class="line">        file_data = f.read()</span><br><span class="line"></span><br><span class="line">    content_type = <span class="string">&quot;application/octet-stream&quot;</span></span><br><span class="line">    <span class="built_in">date</span> = datetime.datetime.utcnow().strftime(<span class="string">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span>)</span><br><span class="line"></span><br><span class="line">    signature = generate_signature(</span><br><span class="line">        method=<span class="string">&quot;PUT&quot;</span>,</span><br><span class="line">        bucket=BUCKET_NAME,</span><br><span class="line">        object_key=object_key,</span><br><span class="line">        content_type=content_type,</span><br><span class="line">        <span class="built_in">date</span>=<span class="built_in">date</span>,</span><br><span class="line">        secret_key=SECRET_KEY</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: content_type,</span><br><span class="line">        <span class="string">&quot;Date&quot;</span>: <span class="built_in">date</span>,</span><br><span class="line">        <span class="string">&quot;Authorization&quot;</span>: f<span class="string">&quot;AWS &#123;ACCESS_KEY&#125;:&#123;signature&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    url = f<span class="string">&quot;&#123;RGW_ENDPOINT&#125;/&#123;BUCKET_NAME&#125;/&#123;object_key&#125;?position=&#123;position&#125;&amp;append=true&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Request URL:&quot;</span>, url)  <span class="comment"># 调试信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Headers:&quot;</span>, headers)  <span class="comment"># 调试信息</span></span><br><span class="line"></span><br><span class="line">    response = requests.put(url, headers=headers, data=file_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response.status_code == 200:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Append successful!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Response headers:&quot;</span>, response.headers)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(f<span class="string">&quot;Append failed! Status code: &#123;response.status_code&#125;, Response: &#123;response.text&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != 4:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python3 test4.py &lt;object_key&gt; &lt;file_path&gt; &lt;position&gt;&quot;</span>)</span><br><span class="line">        sys.exit(1)</span><br><span class="line"></span><br><span class="line">    object_key = sys.argv[1]</span><br><span class="line">    file_path = sys.argv[2]</span><br><span class="line">    position = sys.argv[3]</span><br><span class="line"></span><br><span class="line">    upload_object(object_key, file_path, position)</span><br></pre></td></tr></table></figure>


<p>可以看到签名的地方并没有改变，改变的就是请求的questsring发生了变化</p>
<p>看下运行效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># python3 test4.py  restaaa zp.txt 0</span></span><br><span class="line">String to sign: PUT</span><br><span class="line"></span><br><span class="line">application/octet-stream</span><br><span class="line">Fri, 13 Dec 2024 07:13:33 GMT</span><br><span class="line">/testbucket/restaaa</span><br><span class="line">Request URL: http://192.168.0.101:7481/testbucket/restaaa?position=0&amp;append=<span class="literal">true</span></span><br><span class="line">Headers: &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/octet-stream&#x27;</span>, <span class="string">&#x27;Date&#x27;</span>: <span class="string">&#x27;Fri, 13 Dec 2024 07:13:33 GMT&#x27;</span>, <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;AWS test1:3J3okCbKD2WVsNpfngjMPqBmvVU=&#x27;</span>&#125;</span><br><span class="line">Append successful!</span><br><span class="line">Response headers: &#123;<span class="string">&#x27;Content-Length&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;ETag&#x27;</span>: <span class="string">&#x27;&quot;0a2806dcc91865a811d19150084f6de7&quot;&#x27;</span>, <span class="string">&#x27;Accept-Ranges&#x27;</span>: <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;x-rgw-next-append-position&#x27;</span>: <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;x-amz-request-id&#x27;</span>: <span class="string">&#x27;tx00000ec3108225d59c5e1-00675bde9d-37bd-default&#x27;</span>, <span class="string">&#x27;Date&#x27;</span>: <span class="string">&#x27;Fri, 13 Dec 2024 07:13:33 GMT&#x27;</span>, <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;Keep-Alive&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到返回的x-rgw-next-append-position为16，也就是下个请求应该从16开始</p>
<p>查看文件大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 site-packages]<span class="comment"># aws --endpoint=http://192.168.0.101:7481 s3 ls s3://testbucket/restaaa</span></span><br><span class="line">2024-12-13 15:13:33         16 restaaa</span><br></pre></td></tr></table></figure>

<p>再次请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 ceph]<span class="comment"># python3 test4.py  restaaa zp.txt 16</span></span><br><span class="line">String to sign: PUT</span><br><span class="line"></span><br><span class="line">application/octet-stream</span><br><span class="line">Fri, 13 Dec 2024 07:14:29 GMT</span><br><span class="line">/testbucket/restaaa</span><br><span class="line">Request URL: http://192.168.0.101:7481/testbucket/restaaa?position=16&amp;append=<span class="literal">true</span></span><br><span class="line">Headers: &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/octet-stream&#x27;</span>, <span class="string">&#x27;Date&#x27;</span>: <span class="string">&#x27;Fri, 13 Dec 2024 07:14:29 GMT&#x27;</span>, <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;AWS test1:PsYEAg3YnDb8PVBvRWSKL7nPhy0=&#x27;</span>&#125;</span><br><span class="line">Append successful!</span><br><span class="line">Response headers: &#123;<span class="string">&#x27;Content-Length&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;ETag&#x27;</span>: <span class="string">&#x27;&quot;0a2806dcc91865a811d19150084f6de7&quot;&#x27;</span>, <span class="string">&#x27;Accept-Ranges&#x27;</span>: <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;x-rgw-next-append-position&#x27;</span>: <span class="string">&#x27;32&#x27;</span>, <span class="string">&#x27;x-amz-request-id&#x27;</span>: <span class="string">&#x27;tx00000cbe7cf038ff40327-00675bded5-37bd-default&#x27;</span>, <span class="string">&#x27;Date&#x27;</span>: <span class="string">&#x27;Fri, 13 Dec 2024 07:14:29 GMT&#x27;</span>, <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;Keep-Alive&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>再次查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lab101 site-packages]<span class="comment"># aws --endpoint=http://192.168.0.101:7481 s3 ls s3://testbucket/restaaa</span></span><br><span class="line">2024-12-13 15:14:29         32 restaaa</span><br></pre></td></tr></table></figure>

<p>可以看到文件追加写进去了 </p>
<p>上面的例子是用的v2认证做的例子，v2认证比v4要简单一些</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇介绍了ceph这边的rgw的追加写的功能验证，可以看到跟aws类似，关键字做一点改变即可，本篇从三个工具讲述了ceph里面的追加写的功能，Python的boto的sdk的方法，aws的工具的方法，以及restapi的方法，从三个地方讲述了怎样发起追加写的请求，整体上还是比较简单就是对着指定的位置发起请求即可，就是请求的时候带上一个偏移量</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/logo.jpeg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/logo.jpeg" title="头像" alt="头像"></a><div class="post-copyright__author_name">zphj1987</div><div class="post-copyright__author_desc">但行好事，莫问前程</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/')">rgw追加写功能测试验证</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/images/wechatmei.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/wechatmei.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/zhifubaomei.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/zhifubaomei.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=rgw追加写功能测试验证&amp;url=https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/&amp;pic=/images/blog/s3forheader.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zphj1987.com" target="_blank">磨磨的技术笔记</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/ceph/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ceph<span class="tagsPageCount">15</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/images/blog/vdbenchtest.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/12/11/%E7%BA%A0%E5%88%A0%E7%A0%81%E4%B8%AD%E9%97%B4%E5%AF%B9%E8%B1%A1%E5%B1%9E%E6%80%A7%E4%B8%A2%E5%A4%B1%E5%BC%95%E8%B5%B7osd%E7%9A%84%E5%B4%A9%E6%BA%83/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/crashstorage.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">纠删码中间对象属性丢失引起osd的崩溃</div></div></a></div><div class="next-post pull-right"><a href="/2024/12/16/esxi%E5%85%8B%E9%9A%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E6%B3%95/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/z.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">esxi克隆虚拟机方法</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/04/30/ceph-mon%E5%8D%A1%E6%AD%BB%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E5%A4%84%E7%90%86/" title="ceph-mon卡死故障分析处理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/monhung.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-04-30</div><div class="title">ceph-mon卡死故障分析处理</div></div></a></div><div><a href="/2024/09/05/ceph-radosgw%E9%85%8D%E7%BD%AEbucket%E7%9A%84policy/" title="ceph-radosgw配置bucket的policy"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/policyimage.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-05</div><div class="title">ceph-radosgw配置bucket的policy</div></div></a></div><div><a href="/2024/11/07/cephfs%E7%BB%9F%E8%AE%A1%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E7%9A%84%E8%84%9A%E6%9C%AC/" title="cephfs统计稀疏文件大小的脚本"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/filesize.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-11-07</div><div class="title">cephfs统计稀疏文件大小的脚本</div></div></a></div><div><a href="/2024/11/21/device-health-metrics%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95/" title="device_health_metrics正确的删除方法"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/deletepool.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-11-21</div><div class="title">device_health_metrics正确的删除方法</div></div></a></div><div><a href="/2024/06/26/rbd%E5%81%9A%E5%BF%AB%E7%85%A7%E5%85%8B%E9%9A%86%E4%BB%A5%E5%90%8E%E7%9A%84%E5%AE%B9%E9%87%8F%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/" title="rbd做快照克隆以后的容量相关问题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/clone.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-06-26</div><div class="title">rbd做快照克隆以后的容量相关问题</div></div></a></div><div><a href="/2023/01/31/s3%E7%9A%84v2%E8%AE%A4%E8%AF%81%E6%9E%84%E9%80%A0-lua/" title="s3的v2认证构造-lua"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/default_cover_1.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-01-31</div><div class="title">s3的v2认证构造-lua</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/logo.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、技术、开发</b>相关的问题和看法</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">zphj1987</h1><div class="author-info__desc">但行好事，莫问前程</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/zphj1987" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E5%88%B0%E5%8A%9F%E8%83%BD%E7%9A%84%E5%8F%91%E5%B8%83%E5%A4%A7%E6%A6%82%E6%97%B6%E9%97%B4"><span class="toc-number">1.1.</span> <span class="toc-text">找到功能的发布大概时间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ceph%E8%BF%99%E8%BE%B9%E7%9A%84%E9%80%82%E9%85%8D"><span class="toc-number">2.</span> <span class="toc-text">ceph这边的适配</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E7%9A%84%E9%AA%8C%E8%AF%81"><span class="toc-number">3.</span> <span class="toc-text">功能的验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9Aboto3%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">确定boto3的位置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD"><span class="toc-number">4.1.</span> <span class="toc-text">验证追加写功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aws%E7%9A%84%E8%BF%BD%E5%8A%A0%E5%86%99%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">aws的追加写方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#restapi%E8%BF%BD%E5%8A%A0%E5%86%99%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">6.</span> <span class="toc-text">restapi追加写的功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/02/12/vdbench%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%8C%96/" title="vdbench测试过程可视化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/vdbenchtest.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vdbench测试过程可视化"/></a><div class="content"><a class="title" href="/2025/02/12/vdbench%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%8C%96/" title="vdbench测试过程可视化">vdbench测试过程可视化</a><time datetime="2025-02-12T09:28:31.000Z" title="发表于 2025-02-12 17:28:31">2025-02-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/08/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E7%9A%84deepseek%E7%8E%AF%E5%A2%83/" title="搭建一个本地的deepseek环境"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/deepseek.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="搭建一个本地的deepseek环境"/></a><div class="content"><a class="title" href="/2025/02/08/%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E7%9A%84deepseek%E7%8E%AF%E5%A2%83/" title="搭建一个本地的deepseek环境">搭建一个本地的deepseek环境</a><time datetime="2025-02-08T02:46:38.000Z" title="发表于 2025-02-08 10:46:38">2025-02-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/31/%E5%B0%8F%E7%94%B5%E8%A7%86%E5%B1%8F%E5%B9%95%E6%8B%89%E4%BC%B8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" title="小电视屏幕拉伸问题解决"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/20241231145712.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="小电视屏幕拉伸问题解决"/></a><div class="content"><a class="title" href="/2024/12/31/%E5%B0%8F%E7%94%B5%E8%A7%86%E5%B1%8F%E5%B9%95%E6%8B%89%E4%BC%B8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" title="小电视屏幕拉伸问题解决">小电视屏幕拉伸问题解决</a><time datetime="2024-12-31T06:59:35.000Z" title="发表于 2024-12-31 14:59:35">2024-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/20/%E6%B8%85%E7%90%86macos%E4%B8%8B%E7%9A%84citrix%E6%AE%8B%E7%95%99/" title="清理macos下的citrix残留"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/z.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="清理macos下的citrix残留"/></a><div class="content"><a class="title" href="/2024/12/20/%E6%B8%85%E7%90%86macos%E4%B8%8B%E7%9A%84citrix%E6%AE%8B%E7%95%99/" title="清理macos下的citrix残留">清理macos下的citrix残留</a><time datetime="2024-12-20T08:25:42.000Z" title="发表于 2024-12-20 16:25:42">2024-12-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/20/tgt%E7%9A%84chap%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81%E8%AE%A4%E8%AF%81%E9%80%BB%E8%BE%91/" title="tgt的chap双向认证认证逻辑"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/blog/z.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="tgt的chap双向认证认证逻辑"/></a><div class="content"><a class="title" href="/2024/12/20/tgt%E7%9A%84chap%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81%E8%AE%A4%E8%AF%81%E9%80%BB%E8%BE%91/" title="tgt的chap双向认证认证逻辑">tgt的chap双向认证认证逻辑</a><time datetime="2024-12-20T06:51:33.000Z" title="发表于 2024-12-20 14:51:33">2024-12-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/shangban.svg" alt="距离月入25k也就还差一个大佬带我~" title="距离月入25k也就还差一个大佬带我~"/><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2015 - 2025 By <a class="footer-bar-link" href="/" title="zphj1987" target="_blank">zphj1987</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="鄂ICP备2022001754号-2">鄂ICP备2022001754号-2</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">384</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">34</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">21</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">其它站点</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/zphj1987" title="CSDN-武汉磨磨"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN-武汉磨磨"/><span class="back-menu-item-text">CSDN-武汉磨磨</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文库</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 文章列表</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 全部分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 全部标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/sitemap.xml"><span> sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>1</sup></a><a href="/tags/ceph/" style="font-size: 0.88rem;">ceph<sup>15</sup></a><a href="/tags/chatgpt/" style="font-size: 0.88rem;">chatgpt<sup>1</sup></a><a href="/tags/deepseek/" style="font-size: 0.88rem;">deepseek<sup>1</sup></a><a href="/tags/docker/" style="font-size: 0.88rem;">docker<sup>2</sup></a><a href="/tags/exsi/" style="font-size: 0.88rem;">exsi<sup>1</sup></a><a href="/tags/iscsi%E7%9B%B8%E5%85%B3/" style="font-size: 0.88rem;">iscsi相关<sup>1</sup></a><a href="/tags/lvm/" style="font-size: 0.88rem;">lvm<sup>1</sup></a><a href="/tags/macos/" style="font-size: 0.88rem;">macos<sup>1</sup></a><a href="/tags/openai/" style="font-size: 0.88rem;">openai<sup>1</sup></a><a href="/tags/samba/" style="font-size: 0.88rem;">samba<sup>1</sup></a><a href="/tags/windows/" style="font-size: 0.88rem;">windows<sup>2</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 0.88rem;">内核<sup>2</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2%E7%9B%B8%E5%85%B3/" style="font-size: 0.88rem;">博客相关<sup>1</sup></a><a href="/tags/%E5%AD%98%E5%82%A8/" style="font-size: 0.88rem;">存储<sup>1</sup></a><a href="/tags/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/" style="font-size: 0.88rem;">存储相关<sup>1</sup></a><a href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" style="font-size: 0.88rem;">异常处理<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">操作系统<sup>2</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">数据管理<sup>1</sup></a><a href="/tags/%E6%9A%82%E6%9C%AA%E5%88%86%E7%B1%BB/" style="font-size: 0.88rem;">暂未分类<sup>302</sup></a><a href="/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" style="font-size: 0.88rem;">杂七杂八<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">测试<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3/" style="font-size: 0.88rem;">测试相关<sup>1</sup></a><a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 0.88rem;">监控<sup>1</sup></a><a href="/tags/%E7%A3%81%E7%9B%98/" style="font-size: 0.88rem;">磁盘<sup>1</sup></a><a href="/tags/%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3/" style="font-size: 0.88rem;">磁盘相关<sup>1</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/" style="font-size: 0.88rem;">系统服务<sup>1</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/" style="font-size: 0.88rem;">系统配置<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 0.88rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 0.88rem;">虚拟化<sup>2</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size: 0.88rem;">计算机<sup>1</sup></a><a href="/tags/%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" style="font-size: 0.88rem;">问题处理<sup>1</sup></a><a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/" style="font-size: 0.88rem;">高可用<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("03/19/2015 12:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "/images/xiaban.svg";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'zphj1987/zphj1987.github.io',
      'data-repo-id': 'R_kgDOIV6zlA',
      'data-category-id': 'DIC_kwDOIV6zlM4Cg8XC',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },{"data-lang":"zh-CN","data-mapping":"pathname","data-category":"Announcements","data-input-position":"bottom"})

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  anzhiyu.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>