

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.jpeg">
  <link rel="icon" href="/img/logo.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="zphj1987">
  <meta name="keywords" content="">
  
    <meta name="description" content="背景aws的s3以前是不支持追加写这个功能的  这个存储类型大概是2023年发布的，这个文章是2024年11月21日发布的 找到功能的发布大概时间我们看下boto3的工具是什么时候集成进去的就知道这个功能发布的大概的时间 1WriteOffsetBytes aws里面使用这个参数去控制追加写的偏移量的，我们根据这个关键字去找 找到botcore的代码，使用git下载下来 1cd  botocore">
<meta property="og:type" content="article">
<meta property="og:title" content="rgw追加写功能测试验证">
<meta property="og:url" content="https://zphj1987.com/2024/12/13/rgw%E8%BF%BD%E5%8A%A0%E5%86%99%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81/index.html">
<meta property="og:site_name" content="磨磨的技术笔记">
<meta property="og:description" content="背景aws的s3以前是不支持追加写这个功能的  这个存储类型大概是2023年发布的，这个文章是2024年11月21日发布的 找到功能的发布大概时间我们看下boto3的工具是什么时候集成进去的就知道这个功能发布的大概的时间 1WriteOffsetBytes aws里面使用这个参数去控制追加写的偏移量的，我们根据这个关键字去找 找到botcore的代码，使用git下载下来 1cd  botocore">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zphj1987.com/images/blog/s3forheader.png">
<meta property="article:published_time" content="2024-12-13T09:24:30.000Z">
<meta property="article:modified_time" content="2025-02-13T07:21:00.971Z">
<meta property="article:author" content="zphj1987">
<meta property="article:tag" content="ceph">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://zphj1987.com/images/blog/s3forheader.png">
  
  
  
  <title>rgw追加写功能测试验证 - 磨磨的技术笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"zphj1987.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="磨磨的技术笔记" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>磨磨的技术笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/images/blog/s3forheader.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.8)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="rgw追加写功能测试验证"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-13 17:24" pubdate>
          2024年12月13日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          33 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">rgw追加写功能测试验证</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>aws的s3以前是不支持追加写这个功能的</p>
<p><img src="/images/blog/Pasted%20image%2020241213100200.png" srcset="/img/loading.gif" lazyload></p>
<p>这个存储类型大概是2023年发布的，这个文章是2024年11月21日发布的</p>
<h3 id="找到功能的发布大概时间"><a href="#找到功能的发布大概时间" class="headerlink" title="找到功能的发布大概时间"></a>找到功能的发布大概时间</h3><p>我们看下boto3的工具是什么时候集成进去的就知道这个功能发布的大概的时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">WriteOffsetBytes<br></code></pre></td></tr></table></figure>
<p>aws里面使用这个参数去控制追加写的偏移量的，我们根据这个关键字去找</p>
<p>找到botcore的代码，使用git下载下来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span>  botocore/botocore/data/s3/2006-03-01<br></code></pre></td></tr></table></figure>
<p>进入到这个目录，这个目录里面是aws的s3的接口文档，也就是不管是用python的sdk还是使用aws进行操作的时候，命令行的一些接口都是通过这个目录里面的json文件去判断的</p>
<p>找到这个文件的所有的历史提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">log</span> -p service-2.json<br></code></pre></td></tr></table></figure>

<p>找到了这个地方的提交代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">@@ -9579,6 +9667,12 @@<br>           <span class="hljs-string">&quot;location&quot;</span>:<span class="hljs-string">&quot;uri&quot;</span>,<br>           <span class="hljs-string">&quot;locationName&quot;</span>:<span class="hljs-string">&quot;Key&quot;</span><br>         &#125;,<br>+        <span class="hljs-string">&quot;WriteOffsetBytes&quot;</span>:&#123;<br>+          <span class="hljs-string">&quot;shape&quot;</span>:<span class="hljs-string">&quot;WriteOffsetBytes&quot;</span>,<br>+          <span class="hljs-string">&quot;documentation&quot;</span>:<span class="hljs-string">&quot;&lt;p&gt; Specifies the offset for appending data to existing objects in bytes. The offset must be equal to the size of the existing object being appended to. If no object exists, setting this header to 0 will create a new object. &lt;/p&gt; &lt;note&gt; &lt;p&gt;This functionality is only supported for objects in the Amazon S3 Express One Zone storage class in directory buckets.&lt;/p&gt; &lt;/note&gt;&quot;</span>,<br>+          <span class="hljs-string">&quot;location&quot;</span>:<span class="hljs-string">&quot;header&quot;</span>,<br>+          <span class="hljs-string">&quot;locationName&quot;</span>:<span class="hljs-string">&quot;x-amz-write-offset-bytes&quot;</span><br>+        &#125;,<br></code></pre></td></tr></table></figure>

<p>找到5c8efd314eee44949f6a9e1fb8af522c654ded15这个提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">commit 5c8efd314eee44949f6a9e1fb8af522c654ded15<br>Author: aws-sdk-python-automation &lt;github-aws-sdk-python-automation@amazon.com&gt;<br>Date:   Fri Nov 22 00:52:00 2024 +0000<br><br>    Update to latest models<br></code></pre></td></tr></table></figure>
<p>因为这个模型的提交很频繁，所以这个提交里面也不会单独说明这个功能</p>
<p>查看这次提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git  show 5c8efd314eee44949f6a9e1fb8af522c654ded15  service-2.json<br></code></pre></td></tr></table></figure>

<p>确认就是这个提交里面增加的</p>
<p>也就是上面的2024年的11月21日，跟上面的发布时间基本对上了，也就是那边发布了接口文档，这边适配几个关键字就可以使用相关的功能了，这个松耦合做的非常好</p>
<h2 id="ceph这边的适配"><a href="#ceph这边的适配" class="headerlink" title="ceph这边的适配"></a>ceph这边的适配</h2><p>我们看下官方文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.ceph.com/en/reef/radosgw/s3/objectops/<br></code></pre></td></tr></table></figure>

<p>返回的关键字是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">x-rgw-next-append-position<br></code></pre></td></tr></table></figure>

<p>那我们查询这个关键字就知道什么时候合入的这个功能的</p>
<p><img src="/images/blog/Pasted%20image%2020241213103133.png" srcset="/img/loading.gif" lazyload></p>
<p>最开始在2018年就提出来了，这个是阿里云的oss支持这个功能，然后ceph这边做了适配，这个地方从时间线上面aws官方这个发布的时间有点晚</p>
<p><img src="/images/blog/Pasted%20image%2020241213103407.png" srcset="/img/loading.gif" lazyload></p>
<p>在2019年的2月就合入了这个功能了，也就是基本上2019年2月后面的主发行版本应该都是支持这个功能的</p>
<h2 id="功能的验证"><a href="#功能的验证" class="headerlink" title="功能的验证"></a>功能的验证</h2><p>官方的说明</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/main/examples/rgw/boto3/README.md">https://github.com/ceph/ceph/blob/main/examples/rgw/boto3/README.md</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">This directory contains examples on how to use AWS CLI/boto3 to exercise the RadosGW extensions to the S3 API. This is an extension to the [AWS SDK](https://github.com/boto/botocore/blob/develop/botocore/data/s3/2006-03-01/service-2.json).<br><br>For the standard client to support these extensions, the `service-2.sdk-extras.json` file should be added. You can place it under the default folder `~/.aws/models/s3/2006-03-01/` or create a custom one `/path/to/custom/folder/models/s3/2006-03-01/` and add it to `AWS_DATA_PATH` environment variable. For more information see [here](https://github.com/boto/botocore/blob/develop/botocore/loaders.py<span class="hljs-comment">#L33).</span><br></code></pre></td></tr></table></figure>

<p>这个写的是，这个目录下面有怎样使用aws的客户端和boto3的例子，以及相关的api的扩展，一般兼容性s3接口的做法是基于s3的原生标准接口再做扩展操作，这个里面就是相关的api的文件，我们需要把ceph官方提供的service-2.sdk-extras.json，添加到正在使用的boto3的sdk里面去，具体操作下面会写</p>
<h2 id="确定boto3的位置"><a href="#确定boto3的位置" class="headerlink" title="确定boto3的位置"></a>确定boto3的位置</h2><p>这个地方很容易出问题，因为可能环境里面装了不同版本的boto3，可能重新安装就按照了新的版本，也有可能通过不同的命令安装了不同的版本，我们需要确定好我们正在使用的boto3的库在哪里</p>
<p>安装boto3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 site-packages]<span class="hljs-comment"># pip3 install boto3==1.35.79  botocore==1.35.79  -i https://mirrors.aliyun.com/pypi/simple</span><br></code></pre></td></tr></table></figure>

<p>这里我指定了安装的版本，因为aws对这个botocore的版本有要求，然后隔一天boto重新安装就升级了，可以通过上面的命令来按照指定的版本即可</p>
<p>确定路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 site-packages]<span class="hljs-comment"># python3</span><br>Python 3.9.6 (default, Dec 12 2024, 16:15:26)<br>[GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux<br>Type <span class="hljs-string">&quot;help&quot;</span>, <span class="hljs-string">&quot;copyright&quot;</span>, <span class="hljs-string">&quot;credits&quot;</span> or <span class="hljs-string">&quot;license&quot;</span> <span class="hljs-keyword">for</span> more information.<br>&gt;&gt;&gt; import botocore<br>&gt;&gt;&gt; <span class="hljs-built_in">print</span>(botocore)<br>&lt;module <span class="hljs-string">&#x27;botocore&#x27;</span> from <span class="hljs-string">&#x27;/usr/local/lib/python3.9/site-packages/botocore/__init__.py&#x27;</span>&gt;<br></code></pre></td></tr></table></figure>
<p>可以看到路径在</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/local/lib/python3.9/site-packages/botocore<br></code></pre></td></tr></table></figure>
<p>注意下我们的模型是在这个下面的botocore里面的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 2006-03-01]<span class="hljs-comment"># ll /usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/</span><br>total 248<br>-rw-r--r-- 1 root root  18305 Dec 13 10:48 endpoint-rule-set-1.json.gz<br>-rw-r--r-- 1 root root  57596 Dec 13 10:48 examples-1.json<br>-rw-r--r-- 1 root root   1837 Dec 13 10:48 paginators-1.json<br>-rw-r--r-- 1 root root    856 Dec 13 10:48 paginators-1.sdk-extras.json<br>-rw-r--r-- 1 root root 154059 Dec 13 10:48 service-2.json.gz<br>-rw-r--r-- 1 root root     98 Dec 13 10:48 service-2.sdk-extras.json<br>-rw-r--r-- 1 root root   1436 Dec 13 10:48 waiters-2.json<br></code></pre></td></tr></table></figure>
<p>查看这个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 2006-03-01]<span class="hljs-comment"># cat /usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/service-2.sdk-extras.json</span><br>&#123;<br>  <span class="hljs-string">&quot;version&quot;</span>: 1.0,<br>  <span class="hljs-string">&quot;merge&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;shapes&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;Expires&quot;</span>:&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;timestamp&quot;</span>&#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这个文件是没有什么内容的，我们需要把ceph的扩展放到这个里面 </p>
<p>这个去自己使用的ceph版本里面找，跨版本有可能出现当前版本没支持，后面版本支持的情况，所以尽量使用当前版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/ceph/ceph/blob/v15.2.17/examples/boto3/service-2.sdk-extras.json<br></code></pre></td></tr></table></figure>

<p>比如上面这个是我要测试的版本的，下面是当前最新版本的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/ceph/ceph/blob/main/examples/rgw/boto3/service-2.sdk-extras.json<br></code></pre></td></tr></table></figure>

<p>可以看到路径发生了变化，把boto3的放到rgw下面去了，这个找下即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ~]<span class="hljs-comment">#wget  https://raw.githubusercontent.com/ceph/ceph/refs/heads/main/examples/rgw/boto3/service-2.sdk-extras.json</span><br>[root@lab101 ~]<span class="hljs-comment"># cp service-2.sdk-extras.json /usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/service-2.sdk-extras.json</span><br><span class="hljs-built_in">cp</span>: overwrite ‘/usr/local/lib/python3.9/site-packages/botocore/data/s3/2006-03-01/service-2.sdk-extras.json’? y<br></code></pre></td></tr></table></figure>

<p>替换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 2006-03-01]<span class="hljs-comment"># cat service-2.sdk-extras.json |grep Append</span><br>                <span class="hljs-string">&quot;AppendPosition&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;shape&quot;</span>:<span class="hljs-string">&quot;AppendPosition&quot;</span>,<br>                <span class="hljs-string">&quot;Append&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;shape&quot;</span>:<span class="hljs-string">&quot;Append&quot;</span>,<br>                    <span class="hljs-string">&quot;documentation&quot;</span>:<span class="hljs-string">&quot;&lt;p&gt;Append Object&lt;/p&gt;&quot;</span>,<br>        <span class="hljs-string">&quot;Append&quot;</span>: &#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;boolean&quot;</span>&#125;,<br>        <span class="hljs-string">&quot;AppendPosition&quot;</span>:&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span>&#125;,<br>                <span class="hljs-string">&quot;AppendPosition&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;shape&quot;</span>:<span class="hljs-string">&quot;AppendPosition&quot;</span>,<br></code></pre></td></tr></table></figure>
<p>检查确认下相关的关键字已经放入了，上面的就是确认有了</p>
<h3 id="验证追加写功能"><a href="#验证追加写功能" class="headerlink" title="验证追加写功能"></a>验证追加写功能</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/v15.2.17/examples/boto3/append_object.py">https://github.com/ceph/ceph/blob/v15.2.17/examples/boto3/append_object.py</a></p>
</blockquote>
<p>这个是ceph官方提供的例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/python</span><br>from __future__ import print_function<br><br>import boto3<br>import sys<br>import json<br><br>def js_print(arg):<br>    <span class="hljs-built_in">print</span>(json.dumps(arg, indent=2))<br><br><span class="hljs-keyword">if</span> len(sys.argv) != 3:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage: &#x27;</span> + sys.argv[0] + <span class="hljs-string">&#x27; &lt;bucket&gt; &lt;key&gt;&#x27;</span>)<br>    sys.exit(1)<br><br><span class="hljs-comment"># bucket name as first argument</span><br>bucketname = sys.argv[1]<br>keyname = sys.argv[2]<br><span class="hljs-comment"># endpoint and keys from vstart</span><br>endpoint = <span class="hljs-string">&#x27;http://127.0.0.1:8000&#x27;</span><br>access_key=<span class="hljs-string">&#x27;0555b35654ad1656d804&#x27;</span><br>secret_key=<span class="hljs-string">&#x27;h7GhxuBLTrlhVUyxSPUKUV8r/2EI4ngqJxD7iBdBYLhwluN30JaT3Q==&#x27;</span><br><br>client = boto3.client(<span class="hljs-string">&#x27;s3&#x27;</span>,<br>        endpoint_url=endpoint,<br>        aws_access_key_id=access_key,<br>        aws_secret_access_key=secret_key)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;deleting object first&#x27;</span>)<br>js_print(client.delete_object(Bucket=bucketname, Key=keyname))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;appending at position 0&#x27;</span>)<br>resp = client.put_object(Bucket=bucketname, Key=keyname,<br>                         Append=True,<br>                         AppendPosition=0,<br>                         Body=<span class="hljs-string">&#x27;8letters&#x27;</span>)<br><br>js_print(resp)<br>append_pos = resp[<span class="hljs-string">&#x27;AppendPosition&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;appending at position %d&#x27;</span> % append_pos)<br>js_print(client.put_object(Bucket=bucketname, Key=keyname,<br>                           Append=True,<br>                           AppendPosition=append_pos,<br>                           Body=<span class="hljs-string">&#x27;8letters&#x27;</span>))<br></code></pre></td></tr></table></figure>

<p>可以看下大概的内容</p>
<ul>
<li>先删除指定的名称的对象</li>
<li>然后在0的位置写入8letters字符</li>
<li>然后在获取返回的AppendPosition</li>
<li>基于AppendPosition写入下一个8letters字符</li>
</ul>
<p>看下aws的官方的例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">s3.put_object(Bucket=<span class="hljs-string">&#x27;amzn-s3-demo-bucket--use2-az2--x-s3&#x27;</span>, Key=<span class="hljs-string">&#x27;2024-11-05-sdk-test&#x27;</span>, Body=b<span class="hljs-string">&#x27;123456789&#x27;</span>, WriteOffsetBytes=9)<br></code></pre></td></tr></table></figure>
<p>大部分是一样的，就是WriteOffsetBytes对应的是ceph的AppendPosition</p>
<p>修改成自己可以用的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># cat test.py</span><br><span class="hljs-comment">#!/usr/bin/python</span><br>from __future__ import print_function<br><br>import boto3<br>import sys<br>import json<br><br>def js_print(arg):<br>    <span class="hljs-built_in">print</span>(json.dumps(arg, indent=2))<br><br><span class="hljs-keyword">if</span> len(sys.argv) != 3:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage: &#x27;</span> + sys.argv[0] + <span class="hljs-string">&#x27; &lt;bucket&gt; &lt;key&gt;&#x27;</span>)<br>    sys.exit(1)<br><br><span class="hljs-comment"># bucket name as first argument</span><br>bucketname = sys.argv[1]<br>keyname = sys.argv[2]<br><span class="hljs-comment"># endpoint and keys from vstart</span><br>endpoint = <span class="hljs-string">&#x27;http://192.168.0.101:7481&#x27;</span><br>access_key=<span class="hljs-string">&#x27;test1&#x27;</span><br>secret_key=<span class="hljs-string">&#x27;test1&#x27;</span><br><br>client = boto3.client(<span class="hljs-string">&#x27;s3&#x27;</span>,<br>        endpoint_url=endpoint,<br>        aws_access_key_id=access_key,<br>        aws_secret_access_key=secret_key)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;deleting object first&#x27;</span>)<br>js_print(client.delete_object(Bucket=bucketname, Key=keyname))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;appending at position 0&#x27;</span>)<br>resp = client.put_object(Bucket=bucketname, Key=keyname,<br>                         Append=True,<br>                         AppendPosition=0,<br>                         Body=<span class="hljs-string">&#x27;8letters&#x27;</span>)<br><br>js_print(resp)<br>append_pos = resp[<span class="hljs-string">&#x27;AppendPosition&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;appending at position %d&#x27;</span> % append_pos)<br>js_print(client.put_object(Bucket=bucketname, Key=keyname,<br>                           Append=True,<br>                           AppendPosition=append_pos,<br>                           Body=<span class="hljs-string">&#x27;8letters&#x27;</span>))<br></code></pre></td></tr></table></figure>

<p>运行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># python3 test.py testbucket myappend.txt</span><br>deleting object first<br>&#123;<br>  <span class="hljs-string">&quot;ResponseMetadata&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;RequestId&quot;</span>: <span class="hljs-string">&quot;tx000001eb3924743c3404f-00675ba47a-37bd-default&quot;</span>,<br>    <span class="hljs-string">&quot;HostId&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;HTTPStatusCode&quot;</span>: 204,<br>    <span class="hljs-string">&quot;HTTPHeaders&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;x-amz-request-id&quot;</span>: <span class="hljs-string">&quot;tx000001eb3924743c3404f-00675ba47a-37bd-default&quot;</span>,<br>      <span class="hljs-string">&quot;date&quot;</span>: <span class="hljs-string">&quot;Fri, 13 Dec 2024 03:05:30 GMT&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;RetryAttempts&quot;</span>: 0<br>  &#125;<br>&#125;<br>appending at position 0<br>&#123;<br>  <span class="hljs-string">&quot;ResponseMetadata&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;RequestId&quot;</span>: <span class="hljs-string">&quot;tx00000952a1aea29f3ea2f-00675ba47a-37bd-default&quot;</span>,<br>    <span class="hljs-string">&quot;HostId&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;HTTPStatusCode&quot;</span>: 200,<br>    <span class="hljs-string">&quot;HTTPHeaders&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content-length&quot;</span>: <span class="hljs-string">&quot;0&quot;</span>,<br>      <span class="hljs-string">&quot;etag&quot;</span>: <span class="hljs-string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,<br>      <span class="hljs-string">&quot;accept-ranges&quot;</span>: <span class="hljs-string">&quot;bytes&quot;</span>,<br>      <span class="hljs-string">&quot;x-rgw-next-append-position&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>      <span class="hljs-string">&quot;x-amz-request-id&quot;</span>: <span class="hljs-string">&quot;tx00000952a1aea29f3ea2f-00675ba47a-37bd-default&quot;</span>,<br>      <span class="hljs-string">&quot;date&quot;</span>: <span class="hljs-string">&quot;Fri, 13 Dec 2024 03:05:30 GMT&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;RetryAttempts&quot;</span>: 0<br>  &#125;,<br>  <span class="hljs-string">&quot;ETag&quot;</span>: <span class="hljs-string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;AppendPosition&quot;</span>: 8<br>&#125;<br>appending at position 8<br>&#123;<br>  <span class="hljs-string">&quot;ResponseMetadata&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;RequestId&quot;</span>: <span class="hljs-string">&quot;tx00000bb44851eb1f0253d-00675ba47a-37bd-default&quot;</span>,<br>    <span class="hljs-string">&quot;HostId&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;HTTPStatusCode&quot;</span>: 200,<br>    <span class="hljs-string">&quot;HTTPHeaders&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content-length&quot;</span>: <span class="hljs-string">&quot;0&quot;</span>,<br>      <span class="hljs-string">&quot;etag&quot;</span>: <span class="hljs-string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,<br>      <span class="hljs-string">&quot;accept-ranges&quot;</span>: <span class="hljs-string">&quot;bytes&quot;</span>,<br>      <span class="hljs-string">&quot;x-rgw-next-append-position&quot;</span>: <span class="hljs-string">&quot;16&quot;</span>,<br>      <span class="hljs-string">&quot;x-amz-request-id&quot;</span>: <span class="hljs-string">&quot;tx00000bb44851eb1f0253d-00675ba47a-37bd-default&quot;</span>,<br>      <span class="hljs-string">&quot;date&quot;</span>: <span class="hljs-string">&quot;Fri, 13 Dec 2024 03:05:30 GMT&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;RetryAttempts&quot;</span>: 0<br>  &#125;,<br>  <span class="hljs-string">&quot;ETag&quot;</span>: <span class="hljs-string">&quot;\&quot;4310bc7480e027b4b5aede530e4ee9df\&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;AppendPosition&quot;</span>: 16<br>&#125;<br></code></pre></td></tr></table></figure>

<p>参数是一个bucket名，一个对象的名称</p>
<p>查看运行的效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># aws --endpoint=http://192.168.0.101:7481 s3 cp  s3://testbucket/myappend.txt  myappend.txt</span><br>download: s3://testbucket/myappend.txt to ./myappend.txt<br>[root@lab101 ceph]<span class="hljs-comment"># cat myappend.txt</span><br>8letters8letters[root@lab101 ceph]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>可以看到追加写的功能成功了,确实有16个字符了</p>
<p>上面的是使用的boto3的sdk做的python的测试用例，看下aws的怎样使用</p>
<h2 id="aws的追加写方法"><a href="#aws的追加写方法" class="headerlink" title="aws的追加写方法"></a>aws的追加写方法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.aws.amazon.com/AmazonS3/latest/userguide/directory-buckets-objects-append.html<br></code></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">aws s3api put-object --bucket amzn-s3-demo-bucket--azid--x-s3 --key sampleinput/file001.bin --body bucket-seed/file001.bin --write-offset-bytes size-of-sampleinput/file001.bin<br></code></pre></td></tr></table></figure>

<p>这个是aws这边的推荐的方法，这个里面有个write-offset-bytes的关键字，这个就是对象的偏移量<br>规则是：<br>指定bucket名称 key指定对象的名称 body指定本地的文件 write-offset-bytes 这个指定偏移量的，也就是存在的对象的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 2006-03-01]<span class="hljs-comment"># cat service-2.json |grep WriteOffsetBytes</span><br>        <span class="hljs-string">&quot;WriteOffsetBytes&quot;</span>:&#123;<br>          <span class="hljs-string">&quot;shape&quot;</span>:<span class="hljs-string">&quot;WriteOffsetBytes&quot;</span>,<br>    <span class="hljs-string">&quot;WriteOffsetBytes&quot;</span>:&#123;<br></code></pre></td></tr></table></figure>
<p>这个地方WriteOffsetBytes会在命令行这边解析为 –write-offset-bytes<br>规则就是大写字符和小写字符之间会插入一个-</p>
<p>这个是aws的这边的解析，在ceph这边是按AppendPosition和Append来解析的，那么我们可以尝试命令行用这个参数测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ~]<span class="hljs-comment"># cat zpappend.txt</span><br>aaaaaaa<br>[root@lab101 ~]<span class="hljs-comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 0</span><br>&#123;<br>    <span class="hljs-string">&quot;ETag&quot;</span>: <span class="hljs-string">&quot;\&quot;15fe514867dd5b4a1abf91ea35ff9e22\&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;AppendPosition&quot;</span>: 8<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下载下来看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># aws --endpoint=http://192.168.0.101:7481 s3 cp s3://testbucket/newappend.txt newappend.txt</span><br>download: s3://testbucket/newappend.txt to ./newappend.txt<br>[root@lab101 ceph]<span class="hljs-comment"># cat newappend.txt</span><br>aaaaaaa<br></code></pre></td></tr></table></figure>

<p>再追加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ~]<span class="hljs-comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 8</span><br>&#123;<br>    <span class="hljs-string">&quot;ETag&quot;</span>: <span class="hljs-string">&quot;\&quot;15fe514867dd5b4a1abf91ea35ff9e22\&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;AppendPosition&quot;</span>: 16<br>&#125;<br></code></pre></td></tr></table></figure>
<p>再下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># aws --endpoint=http://192.168.0.101:7481 s3 cp s3://testbucket/newappend.txt newappend.txt</span><br>download: s3://testbucket/newappend.txt to ./newappend.txt<br>[root@lab101 ceph]<span class="hljs-comment"># cat newappend.txt</span><br>aaaaaaa<br>aaaaaaa<br></code></pre></td></tr></table></figure>

<p>再测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ~]<span class="hljs-comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 8</span><br><br>An error occurred (PositionNotEqualToLength) when calling the PutObject operation: Unknown<br>[root@lab101 ~]<span class="hljs-comment"># aws    s3api put-object   --endpoint=http://192.168.0.101:7481   --bucket testbucket --key newappend.txt --body zpappend.txt --append   --append-position 16</span><br>&#123;<br>    <span class="hljs-string">&quot;ETag&quot;</span>: <span class="hljs-string">&quot;\&quot;15fe514867dd5b4a1abf91ea35ff9e22\&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;AppendPosition&quot;</span>: 24<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到，追加写的时候必须正确的指定已经存在的对象的大小位置，也就是偏移量，从哪里开始追加写</p>
<p>返回的位置就是最后的对象的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># aws --endpoint=http://192.168.0.101:7481 s3 ls s3://testbucket/newappend.txt</span><br>2024-12-13 11:22:10         24 newappend.txt<br></code></pre></td></tr></table></figure>

<p>可以看到追加写成功了</p>
<h2 id="restapi追加写的功能"><a href="#restapi追加写的功能" class="headerlink" title="restapi追加写的功能"></a>restapi追加写的功能</h2><p>下面是正常的上传的代码，不是追加写的功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># cat test1.py</span><br><span class="hljs-comment">#! /usr/bin/python3</span><br><span class="hljs-comment"># -*- coding:utf-8 -*-</span><br>import requests<br>import hashlib<br>import hmac<br>import datetime<br>import <span class="hljs-built_in">base64</span><br><br><span class="hljs-comment"># 配置 Ceph RGW 的访问信息</span><br>ACCESS_KEY = <span class="hljs-string">&quot;test1&quot;</span><br>SECRET_KEY = <span class="hljs-string">&quot;test1&quot;</span><br>RGW_ENDPOINT = <span class="hljs-string">&quot;http://192.168.0.101:7481&quot;</span>  <span class="hljs-comment"># Ceph RADOS Gateway 的地址</span><br>BUCKET_NAME = <span class="hljs-string">&quot;testbucket&quot;</span><br>OBJECT_KEY = <span class="hljs-string">&quot;testrest.txt&quot;</span><br><br><span class="hljs-comment"># 计算 AWS S3 签名</span><br>def generate_signature(method, bucket, object_key, content_type, <span class="hljs-built_in">date</span>, secret_key):<br>    string_to_sign = f<span class="hljs-string">&quot;&#123;method&#125;\n\n&#123;content_type&#125;\n&#123;date&#125;\n/&#123;bucket&#125;/&#123;object_key&#125;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;String to sign:&quot;</span>, string_to_sign)  <span class="hljs-comment"># 调试信息</span><br>    signature = hmac.new(secret_key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), string_to_sign.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), hashlib.sha1).digest()<br>    <span class="hljs-built_in">return</span> base64.b64encode(signature).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br><span class="hljs-comment"># 上传对象到 Ceph</span><br>def upload_object(file_path):<br>    with open(file_path, <span class="hljs-string">&quot;rb&quot;</span>) as f:<br>        file_data = f.read()<br><br>    content_type = <span class="hljs-string">&quot;application/octet-stream&quot;</span><br>    <span class="hljs-built_in">date</span> = datetime.datetime.utcnow().strftime(<span class="hljs-string">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span>)<br><br>    signature = generate_signature(<br>        method=<span class="hljs-string">&quot;PUT&quot;</span>,<br>        bucket=BUCKET_NAME,<br>        object_key=OBJECT_KEY,<br>        content_type=content_type,<br>        <span class="hljs-built_in">date</span>=<span class="hljs-built_in">date</span>,<br>        secret_key=SECRET_KEY<br>    )<br><br>    headers = &#123;<br>        <span class="hljs-string">&quot;Content-Type&quot;</span>: content_type,<br>        <span class="hljs-string">&quot;Date&quot;</span>: <span class="hljs-built_in">date</span>,<br>        <span class="hljs-string">&quot;Authorization&quot;</span>: f<span class="hljs-string">&quot;AWS &#123;ACCESS_KEY&#125;:&#123;signature&#125;&quot;</span><br>    &#125;<br><br>    url = f<span class="hljs-string">&quot;&#123;RGW_ENDPOINT&#125;/&#123;BUCKET_NAME&#125;/&#123;OBJECT_KEY&#125;&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Request URL:&quot;</span>, url)  <span class="hljs-comment"># 调试信息</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Headers:&quot;</span>, headers)  <span class="hljs-comment"># 调试信息</span><br><br>    response = requests.put(url, headers=headers, data=file_data)<br><br>    <span class="hljs-keyword">if</span> response.status_code == 200:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Upload successful!&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(f<span class="hljs-string">&quot;Upload failed! Status code: &#123;response.status_code&#125;, Response: &#123;response.text&#125;&quot;</span>)<br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    upload_object(<span class="hljs-string">&quot;zp.txt&quot;</span>)<br></code></pre></td></tr></table></figure>


<p>我们再来一个追加写的restapi</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># cat test4.py</span><br><span class="hljs-comment">#! /usr/bin/python3</span><br><span class="hljs-comment"># -*- coding:utf-8 -*-</span><br>import requests<br>import hashlib<br>import hmac<br>import datetime<br>import <span class="hljs-built_in">base64</span><br>import sys<br><br><span class="hljs-comment"># 配置 Ceph RGW 的访问信息</span><br>ACCESS_KEY = <span class="hljs-string">&quot;test1&quot;</span><br>SECRET_KEY = <span class="hljs-string">&quot;test1&quot;</span><br>RGW_ENDPOINT = <span class="hljs-string">&quot;http://192.168.0.101:7481&quot;</span>  <span class="hljs-comment"># Ceph RADOS Gateway 的地址</span><br>BUCKET_NAME = <span class="hljs-string">&quot;testbucket&quot;</span><br><br><span class="hljs-comment"># 计算 AWS S3 签名</span><br>def generate_signature(method, bucket, object_key, content_type, <span class="hljs-built_in">date</span>, secret_key):<br>    string_to_sign = f<span class="hljs-string">&quot;&#123;method&#125;\n\n&#123;content_type&#125;\n&#123;date&#125;\n/&#123;bucket&#125;/&#123;object_key&#125;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;String to sign:&quot;</span>, string_to_sign)  <span class="hljs-comment"># 调试信息</span><br>    signature = hmac.new(secret_key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), string_to_sign.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), hashlib.sha1).digest()<br>    <span class="hljs-built_in">return</span> base64.b64encode(signature).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br><span class="hljs-comment"># 上传对象到 Ceph</span><br>def upload_object(object_key, file_path, position):<br>    with open(file_path, <span class="hljs-string">&quot;rb&quot;</span>) as f:<br>        file_data = f.read()<br><br>    content_type = <span class="hljs-string">&quot;application/octet-stream&quot;</span><br>    <span class="hljs-built_in">date</span> = datetime.datetime.utcnow().strftime(<span class="hljs-string">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span>)<br><br>    signature = generate_signature(<br>        method=<span class="hljs-string">&quot;PUT&quot;</span>,<br>        bucket=BUCKET_NAME,<br>        object_key=object_key,<br>        content_type=content_type,<br>        <span class="hljs-built_in">date</span>=<span class="hljs-built_in">date</span>,<br>        secret_key=SECRET_KEY<br>    )<br><br>    headers = &#123;<br>        <span class="hljs-string">&quot;Content-Type&quot;</span>: content_type,<br>        <span class="hljs-string">&quot;Date&quot;</span>: <span class="hljs-built_in">date</span>,<br>        <span class="hljs-string">&quot;Authorization&quot;</span>: f<span class="hljs-string">&quot;AWS &#123;ACCESS_KEY&#125;:&#123;signature&#125;&quot;</span><br>    &#125;<br><br>    url = f<span class="hljs-string">&quot;&#123;RGW_ENDPOINT&#125;/&#123;BUCKET_NAME&#125;/&#123;object_key&#125;?position=&#123;position&#125;&amp;append=true&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Request URL:&quot;</span>, url)  <span class="hljs-comment"># 调试信息</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Headers:&quot;</span>, headers)  <span class="hljs-comment"># 调试信息</span><br><br>    response = requests.put(url, headers=headers, data=file_data)<br><br>    <span class="hljs-keyword">if</span> response.status_code == 200:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Append successful!&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Response headers:&quot;</span>, response.headers)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(f<span class="hljs-string">&quot;Append failed! Status code: &#123;response.status_code&#125;, Response: &#123;response.text&#125;&quot;</span>)<br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">if</span> len(sys.argv) != 4:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python3 test4.py &lt;object_key&gt; &lt;file_path&gt; &lt;position&gt;&quot;</span>)<br>        sys.exit(1)<br><br>    object_key = sys.argv[1]<br>    file_path = sys.argv[2]<br>    position = sys.argv[3]<br><br>    upload_object(object_key, file_path, position)<br></code></pre></td></tr></table></figure>


<p>可以看到签名的地方并没有改变，改变的就是请求的questsring发生了变化</p>
<p>看下运行效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># python3 test4.py  restaaa zp.txt 0</span><br>String to sign: PUT<br><br>application/octet-stream<br>Fri, 13 Dec 2024 07:13:33 GMT<br>/testbucket/restaaa<br>Request URL: http://192.168.0.101:7481/testbucket/restaaa?position=0&amp;append=<span class="hljs-literal">true</span><br>Headers: &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/octet-stream&#x27;</span>, <span class="hljs-string">&#x27;Date&#x27;</span>: <span class="hljs-string">&#x27;Fri, 13 Dec 2024 07:13:33 GMT&#x27;</span>, <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;AWS test1:3J3okCbKD2WVsNpfngjMPqBmvVU=&#x27;</span>&#125;<br>Append successful!<br>Response headers: &#123;<span class="hljs-string">&#x27;Content-Length&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;ETag&#x27;</span>: <span class="hljs-string">&#x27;&quot;0a2806dcc91865a811d19150084f6de7&quot;&#x27;</span>, <span class="hljs-string">&#x27;Accept-Ranges&#x27;</span>: <span class="hljs-string">&#x27;bytes&#x27;</span>, <span class="hljs-string">&#x27;x-rgw-next-append-position&#x27;</span>: <span class="hljs-string">&#x27;16&#x27;</span>, <span class="hljs-string">&#x27;x-amz-request-id&#x27;</span>: <span class="hljs-string">&#x27;tx00000ec3108225d59c5e1-00675bde9d-37bd-default&#x27;</span>, <span class="hljs-string">&#x27;Date&#x27;</span>: <span class="hljs-string">&#x27;Fri, 13 Dec 2024 07:13:33 GMT&#x27;</span>, <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;Keep-Alive&#x27;</span>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到返回的x-rgw-next-append-position为16，也就是下个请求应该从16开始</p>
<p>查看文件大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 site-packages]<span class="hljs-comment"># aws --endpoint=http://192.168.0.101:7481 s3 ls s3://testbucket/restaaa</span><br>2024-12-13 15:13:33         16 restaaa<br></code></pre></td></tr></table></figure>

<p>再次请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 ceph]<span class="hljs-comment"># python3 test4.py  restaaa zp.txt 16</span><br>String to sign: PUT<br><br>application/octet-stream<br>Fri, 13 Dec 2024 07:14:29 GMT<br>/testbucket/restaaa<br>Request URL: http://192.168.0.101:7481/testbucket/restaaa?position=16&amp;append=<span class="hljs-literal">true</span><br>Headers: &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/octet-stream&#x27;</span>, <span class="hljs-string">&#x27;Date&#x27;</span>: <span class="hljs-string">&#x27;Fri, 13 Dec 2024 07:14:29 GMT&#x27;</span>, <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;AWS test1:PsYEAg3YnDb8PVBvRWSKL7nPhy0=&#x27;</span>&#125;<br>Append successful!<br>Response headers: &#123;<span class="hljs-string">&#x27;Content-Length&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;ETag&#x27;</span>: <span class="hljs-string">&#x27;&quot;0a2806dcc91865a811d19150084f6de7&quot;&#x27;</span>, <span class="hljs-string">&#x27;Accept-Ranges&#x27;</span>: <span class="hljs-string">&#x27;bytes&#x27;</span>, <span class="hljs-string">&#x27;x-rgw-next-append-position&#x27;</span>: <span class="hljs-string">&#x27;32&#x27;</span>, <span class="hljs-string">&#x27;x-amz-request-id&#x27;</span>: <span class="hljs-string">&#x27;tx00000cbe7cf038ff40327-00675bded5-37bd-default&#x27;</span>, <span class="hljs-string">&#x27;Date&#x27;</span>: <span class="hljs-string">&#x27;Fri, 13 Dec 2024 07:14:29 GMT&#x27;</span>, <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;Keep-Alive&#x27;</span>&#125;<br></code></pre></td></tr></table></figure>

<p>再次查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@lab101 site-packages]<span class="hljs-comment"># aws --endpoint=http://192.168.0.101:7481 s3 ls s3://testbucket/restaaa</span><br>2024-12-13 15:14:29         32 restaaa<br></code></pre></td></tr></table></figure>

<p>可以看到文件追加写进去了 </p>
<p>上面的例子是用的v2认证做的例子，v2认证比v4要简单一些</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇介绍了ceph这边的rgw的追加写的功能验证，可以看到跟aws类似，关键字做一点改变即可，本篇从三个工具讲述了ceph里面的追加写的功能，Python的boto的sdk的方法，aws的工具的方法，以及restapi的方法，从三个地方讲述了怎样发起追加写的请求，整体上还是比较简单就是对着指定的位置发起请求即可，就是请求的时候带上一个偏移量</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/" class="category-chain-item">存储系统</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ceph/" class="print-no-link">#ceph</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>rgw追加写功能测试验证</div>
      <div>https://zphj1987.com/2024/12/13/rgw追加写功能测试验证/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>zphj1987</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月13日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/12/16/esxi%E5%85%8B%E9%9A%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E6%B3%95/" title="esxi克隆虚拟机方法">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">esxi克隆虚拟机方法</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/11/%E7%BA%A0%E5%88%A0%E7%A0%81%E4%B8%AD%E9%97%B4%E5%AF%B9%E8%B1%A1%E5%B1%9E%E6%80%A7%E4%B8%A2%E5%A4%B1%E5%BC%95%E8%B5%B7osd%E7%9A%84%E5%B4%A9%E6%BA%83/" title="纠删码中间对象属性丢失引起osd的崩溃">
                        <span class="hidden-mobile">纠删码中间对象属性丢失引起osd的崩溃</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      鄂ICP备2025166994号-2
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42011102003786"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>鄂公网安备42011102003786号</span>
        </a>
      </span>
    
  
</div>

  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
